<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="surtvep">
<title>Introduction to surtvep • surtvep</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.1.0/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.1.0/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.rawgit.com/afeld/bootstrap-toc/v1.0.1/dist/bootstrap-toc.min.js"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Introduction to surtvep">
<meta property="og:description" content="surtvep">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">surtvep</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.0.0</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="active nav-item">
  <a class="nav-link" href="../articles/surtvep.html">Get started</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../articles/Model_Parameters.html">Model Parameters</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/UM-KevinHe/surtvep/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Introduction to surtvep</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/UM-KevinHe/surtvep/blob/HEAD/vignettes/surtvep.Rmd" class="external-link"><code>vignettes/surtvep.Rmd</code></a></small>
      <div class="d-none name"><code>surtvep.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="introduction">1. Introduction:<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p><code>Coxtp</code> is an R package for fitting penalized Newton’s
method for the time-varying effects model using mAIC, TIC, GIC as
information criteria, in particular we span the parameter using basis
functions. Utilities for carrying out post-fitting visualization,
summarization, and inference are also provided.</p>
</div>
<div class="section level2">
<h2 id="installation">2. Installation:<a class="anchor" aria-label="anchor" href="#installation"></a>
</h2>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#Install the package, need to install the devtools packages:</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html" class="external-link">install.packages</a></span><span class="op">(</span><span class="st">"devtools"</span><span class="op">)</span></span>
<span><span class="fu">devtools</span><span class="fu">::</span><span class="fu"><a href="https://remotes.r-lib.org/reference/install_github.html" class="external-link">install_github</a></span><span class="op">(</span><span class="st">"UM-KevinHe/surtvep"</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#To install with Vignettes:</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html" class="external-link">install.packages</a></span><span class="op">(</span><span class="st">"devtools"</span><span class="op">)</span></span>
<span><span class="fu">devtools</span><span class="fu">::</span><span class="fu"><a href="https://remotes.r-lib.org/reference/install_github.html" class="external-link">install_github</a></span><span class="op">(</span><span class="st">"UM-KevinHe/surtvep"</span>,build_vignettes <span class="op">=</span><span class="cn">T</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/UM-KevinHe/surtvep" class="external-link">surtvep</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; Loading required package: ggplot2</span></span>
<span><span class="co">#&gt; Loading required package: splines2</span></span>
<span><span class="co">#&gt; Warning: package 'splines2' was built under R version 4.1.3</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="dataset-preperation">3. Dataset preperation:<a class="anchor" aria-label="anchor" href="#dataset-preperation"></a>
</h2>
<p>For the purpose of demonstration, we will use the simulated dataset
“sim_data” in the our package.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sim_data</span><span class="op">=</span><span class="va">sim_data</span></span></code></pre></div>
<p>Let’s check the data first:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">sim_data</span><span class="op">)</span></span>
<span><span class="co">#&gt;      V1 V2 event         time</span></span>
<span><span class="co">#&gt; [1,]  0  0     1 0.0003028248</span></span>
<span><span class="co">#&gt; [2,]  0  0     1 0.0004273569</span></span>
<span><span class="co">#&gt; [3,]  0  0     0 0.0008948164</span></span>
<span><span class="co">#&gt; [4,]  0  0     1 0.0008981023</span></span>
<span><span class="co">#&gt; [5,]  0  0     0 0.0009103830</span></span>
<span><span class="co">#&gt; [6,]  0  0     1 0.0010759157</span></span></code></pre></div>
<p>Here, the covariates V1 and V2 were generated as binary variables
with around 90% frequency. The related true log-hazard function for each
variable is <span class="math inline">\(\beta(t)=1\)</span> and <span class="math inline">\(\beta(t)=exp(-1.5*t)\)</span>, where t denotes
time.</p>
<p>Then, let’s extract the time and event as vector, and get the
remaining information in the dataset as matrix.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">event</span><span class="op">=</span><span class="va">sim_data</span><span class="op">[</span>,<span class="st">"event"</span><span class="op">]</span></span>
<span><span class="va">time</span><span class="op">=</span><span class="va">sim_data</span><span class="op">[</span>,<span class="st">"time"</span><span class="op">]</span></span>
<span><span class="va">data</span><span class="op">=</span><span class="va">sim_data</span><span class="op">[</span>,<span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">sim_data</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"event"</span>,<span class="st">"time"</span><span class="op">)</span><span class="op">]</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="model-fitting">4. Model fitting<a class="anchor" aria-label="anchor" href="#model-fitting"></a>
</h2>
<div class="section level3">
<h3 id="newton-method-without-penalization">4.1 Newton Method without penalization:<a class="anchor" aria-label="anchor" href="#newton-method-without-penalization"></a>
</h3>
<div class="section level4">
<h4 id="simple-fitting">4.1.1 Simple fitting:<a class="anchor" aria-label="anchor" href="#simple-fitting"></a>
</h4>
<p>Let’s fit the model. Here, the default method is Newton Method
without penalization, with smooth-spline. Term
<code>lambda_spline</code> refers to the smoothing parameter lambda
(Detail could be found under both “Model parameter” section or our paper
here(Modified this to XuTao’s site after finished). Default value is
<code>lambda_spline=0</code>, which refers to no penalization). The
number of knots in the base function here is the default which is
<code>nsplines=8</code></p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/coxtp.html">coxtp</a></span><span class="op">(</span>event <span class="op">=</span> <span class="va">event</span>, z <span class="op">=</span> <span class="va">data</span>, time <span class="op">=</span> <span class="va">time</span><span class="op">)</span></span></code></pre></div>
<p>To get the estimated time-varying effect of a specific coefficient,
we could use the following plot function in our package:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/coxtp.plot.html">coxtp.plot</a></span><span class="op">(</span><span class="va">fit</span>,coef<span class="op">=</span><span class="st">"V2"</span><span class="op">)</span></span></code></pre></div>
<p><img src="surtvep_files/figure-html/unnamed-chunk-7-1.png" width="672" style="display: block; margin: auto;"></p>
<p>The plot shows the result of the time-varying effect of Variable
“V2”.</p>
</div>
<div class="section level4">
<h4 id="detailed-calculations-and-theories-">4.1.2 Detailed calculations and theories.<a class="anchor" aria-label="anchor" href="#detailed-calculations-and-theories-"></a>
</h4>
<div class="section level5">
<h5 id="model-results-meanings">4.1.2.1 Model results meanings:<a class="anchor" aria-label="anchor" href="#model-results-meanings"></a>
</h5>
<p>First, Let’s look at the <code>fit</code> result</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">fit</span><span class="op">)</span></span>
<span><span class="co">#&gt;                 Length Class      Mode     </span></span>
<span><span class="co">#&gt; model_result    18     -none-     list     </span></span>
<span><span class="co">#&gt; lambda.selected  1     data.frame list     </span></span>
<span><span class="co">#&gt; p                1     -none-     numeric  </span></span>
<span><span class="co">#&gt; z_names          2     -none-     character</span></span></code></pre></div>
<p>There are 4 results saved under the fit result.</p>
<ul>
<li><p><code>model_result</code> save the detailed model results which
we will explain in a minute.</p></li>
<li><p><code>lambda.selected</code> saved the best lambda chosen based
on different criteria which will not be used for the non-penalized
model.</p></li>
<li><p><code>p</code> refers to the number of covariates used in the
model</p></li>
<li><p><code>z_names</code> records the covariates names.</p></li>
</ul>
<p>The detailed model result was saved in <code>model_result</code>,
which can be called by <code>fit$model_result</code>. Now, let’s explore
the result a little bit:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">fit</span><span class="op">$</span><span class="va">model_result</span><span class="op">)</span></span>
<span><span class="co">#&gt;                Length Class  Mode     </span></span>
<span><span class="co">#&gt; theta             16  -none- numeric  </span></span>
<span><span class="co">#&gt; logplkd            1  -none- numeric  </span></span>
<span><span class="co">#&gt; theta_all         16  -none- numeric  </span></span>
<span><span class="co">#&gt; theta_list         3  -none- list     </span></span>
<span><span class="co">#&gt; AIC_all            1  -none- numeric  </span></span>
<span><span class="co">#&gt; TIC_all            1  -none- numeric  </span></span>
<span><span class="co">#&gt; TIC2_all           1  -none- numeric  </span></span>
<span><span class="co">#&gt; GIC_all            1  -none- numeric  </span></span>
<span><span class="co">#&gt; AIC_trace          1  -none- numeric  </span></span>
<span><span class="co">#&gt; TIC_trace          1  -none- numeric  </span></span>
<span><span class="co">#&gt; TIC2_trace         1  -none- numeric  </span></span>
<span><span class="co">#&gt; GIC_trace          1  -none- numeric  </span></span>
<span><span class="co">#&gt; logplkd_vec        1  -none- numeric  </span></span>
<span><span class="co">#&gt; SplineType         1  -none- character</span></span>
<span><span class="co">#&gt; VarianceMatrix   256  -none- numeric  </span></span>
<span><span class="co">#&gt; uniqfailtimes   2487  -none- numeric  </span></span>
<span><span class="co">#&gt; bases          19896  bs     numeric  </span></span>
<span><span class="co">#&gt; knots              4  -none- numeric</span></span></code></pre></div>
<p>Here we noticed that there are 18 items in the model results list.
Following is an explanation of each item:</p>
<ul>
<li>
<code>theta</code>: Estimation matrix of <span class="math inline">\(\theta\)</span>
</li>
<li>
<code>logplkd</code>: log-partial likelihood</li>
<li>
<code>theta_all</code>: Internal validation use</li>
<li>
<code>theta_list</code>: The estimation matrix at each Newton’s
update</li>
<li>
<code>AIC_all</code>: Akakia information criterion</li>
<li>
<code>TIC_all</code>: Takeuchi information criterion</li>
<li>
<code>TIC2_all</code>: Internal validation use</li>
<li>
<code>GIC_all</code>: Generalized information criterion</li>
<li>
<code>AIC_trace</code>: Internal validation use</li>
<li>
<code>TIC_trace</code>: Internal validation use</li>
<li>
<code>TIC2_trace</code>: Internal validation use</li>
<li>
<code>GIC_trace</code>: Internal validation use</li>
<li>
<code>logplkd_vec</code>: log-partial likelihood at each
iteration</li>
<li>
<code>SplineType</code>: spline used for fitting the model</li>
<li>
<code>VarianceMatrix</code>: Variance Matrix</li>
<li>
<code>uniqfailtimes</code>: The input unique event times if
<code>ties="Breslow"</code>, input time points if
<code>ties="None"</code> (Add link)</li>
<li>
<code>bases</code>: The basis function used for estimating
time-varying effects</li>
<li>
<code>knots</code>: Number of basis functions used for estimating
time-varying effects</li>
</ul>
</div>
<div class="section level5">
<h5 id="how-to-get-the-effect-of-a-specific-time-point">4.1.2.2: How to get the effect of a specific time point?<a class="anchor" aria-label="anchor" href="#how-to-get-the-effect-of-a-specific-time-point"></a>
</h5>
<p>We are more interested in estimating time-varying effect of the
covariates. Following is an simple tutorial of how to do that. First, a
little background about the time-varying effect in cox model(You could
also check this part at our paper which have more detailed
explanation.(insert link))</p>
<p>If we Let <span class="math inline">\(X_i=(X_{i1},X_{i2},...X_{ip})^T\)</span> refers to
the <span class="math inline">\(i_{th}\)</span> individuals in the
dataset with p covariates(which could also be understand as the <span class="math inline">\(i_{th}\)</span> row in the data we extract above).
Let <span class="math inline">\(\lambda(t|X_i)\)</span> denote the
hazard of having the event at time t for the <span class="math inline">\(i_{th}\)</span> individual, <span class="math inline">\(\lambda_0(t)\)</span> denote the hazard of having
the event at time 0. When we considering the covarites having time fixed
effect, we have the following formula for <span class="math inline">\(\lambda(t|X_i)\)</span>:</p>
<p><span class="math inline">\(\lambda(t|X_i)=\lambda_0(t)exp(X_i^T\beta)\)</span></p>
<p>Where <span class="math inline">\(\beta\)</span> refers to the
coefficients where <span class="math inline">\(\beta=(\beta_1,\beta_2,...\beta_p)\)</span>, which
in this example, is (V1, V2). Which have similar format as the GLM
model. For time-varying effect model, we are simply replace <span class="math inline">\(\beta\)</span> with a set of <span class="math inline">\(\beta(t)\)</span>. Thus, the time varying
equations could be transferred as following:</p>
<p><span class="math inline">\(\lambda(t|X_i)=\lambda_0(t)exp(X_i^T\beta(t))\)</span></p>
<p>Similar, <span class="math inline">\(\beta(t)=(\beta_1(t),\beta_2(t),...\beta_p(t))\)</span>
where <span class="math inline">\(\beta(.)\)</span> refers to a set of
cubic B-spline(Details for B-spline refers to here : insert link).
Where, the single <span class="math inline">\(\beta_p(t)\)</span> could
be estimated using the following formula:</p>
<p><span class="math inline">\(\beta_p(t)=\theta_p^TB(t)=\sum_{k=1}^K\theta_{pk}B_k(t)\)</span></p>
<p>Here, K refers to the given number of knots.</p>
<p>Thus, to calculate the time varying effect of coefficient p, we just
need to get both estimated B spline and the <span class="math inline">\(\theta\)</span> matrix. The B-spline was saved in
<code>model_result$bases</code> and <span class="math inline">\(\theta\)</span> matrix was saved in the last item
in <code>model_result$theta_list</code> Following is the code for
calculation:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">model_result</span>  <span class="op">=</span> <span class="va">fit</span><span class="op">$</span><span class="va">model_result</span></span>
<span><span class="va">B.spline</span>      <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="va">model_result</span><span class="op">$</span><span class="va">bases</span><span class="op">)</span></span>
<span><span class="va">theta</span>         <span class="op">=</span> <span class="va">model_result</span><span class="op">$</span><span class="va">theta_list</span><span class="op">[[</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">model_result</span><span class="op">$</span><span class="va">theta_list</span><span class="op">)</span><span class="op">]</span><span class="op">]</span></span>
<span></span>
<span><span class="va">beta</span>          <span class="op">=</span> <span class="va">B.spline</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">theta</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">beta</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 2487    2</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">beta</span><span class="op">)</span></span>
<span><span class="co">#&gt;           [,1]     [,2]</span></span>
<span><span class="co">#&gt; [1,] 0.4574157 1.165634</span></span>
<span><span class="co">#&gt; [2,] 0.4593697 1.165002</span></span>
<span><span class="co">#&gt; [3,] 0.4667205 1.162619</span></span>
<span><span class="co">#&gt; [4,] 0.4694825 1.161720</span></span>
<span><span class="co">#&gt; [5,] 0.4751800 1.159862</span></span>
<span><span class="co">#&gt; [6,] 0.4809900 1.157959</span></span></code></pre></div>
<p>As a result, <span class="math inline">\(\beta\)</span> is a 2487*2
matrix(we are using the “Breslow” ties, thus there are 2487 rows instead
of 5000, detail about ties and Breslow ties could refers to here(insert
link)). We could also get the 95%CI for the estimation, which is
calculates as below:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">B.spline</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="va">model_result</span><span class="op">$</span><span class="va">bases</span><span class="op">)</span>  </span>
<span><span class="va">theta_plot</span>  <span class="op">&lt;-</span> <span class="va">model_result</span><span class="op">$</span><span class="va">theta_list</span><span class="op">[[</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">model_result</span><span class="op">$</span><span class="va">theta_list</span><span class="op">)</span><span class="op">]</span><span class="op">]</span></span>
<span></span>
<span><span class="va">beta</span>     <span class="op">&lt;-</span> <span class="va">B.spline</span><span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">theta_plot</span><span class="op">)</span></span>
<span><span class="va">var</span>      <span class="op">&lt;-</span>  <span class="va">model_result</span><span class="op">$</span><span class="va">VarianceMatrix</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">beta</span><span class="op">)</span><span class="op">=</span><span class="va">fit</span><span class="op">$</span><span class="va">z_names</span></span>
<span><span class="va">p</span>        <span class="op">&lt;-</span> <span class="va">fit</span><span class="op">$</span><span class="va">p</span></span>
<span><span class="va">knot</span>     <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">B.spline</span><span class="op">)</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span></span>
<span><span class="va">list</span>     <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">B.spline</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span></span>
<span><span class="va">beta_low</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">B.spline</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>,<span class="va">p</span><span class="op">)</span></span>
<span><span class="va">beta_up</span>  <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">B.spline</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>,<span class="va">p</span><span class="op">)</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">p</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">beta_t_1</span>   <span class="op">&lt;-</span> <span class="va">beta</span><span class="op">[</span>,<span class="va">i</span><span class="op">]</span></span>
<span>  <span class="va">var2</span>       <span class="op">&lt;-</span> <span class="va">var</span><span class="op">[</span><span class="op">(</span><span class="op">(</span><span class="va">i</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span><span class="op">*</span><span class="va">knot</span><span class="op">+</span><span class="fl">1</span><span class="op">)</span><span class="op">:</span><span class="op">(</span><span class="op">(</span><span class="va">i</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span><span class="op">*</span><span class="va">knot</span><span class="op">+</span><span class="va">knot</span><span class="op">)</span>,<span class="op">(</span><span class="op">(</span><span class="va">i</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span><span class="op">*</span><span class="va">knot</span><span class="op">+</span><span class="fl">1</span><span class="op">)</span><span class="op">:</span><span class="op">(</span><span class="op">(</span><span class="va">i</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span><span class="op">*</span><span class="va">knot</span><span class="op">+</span><span class="va">knot</span><span class="op">)</span><span class="op">]</span></span>
<span>  <span class="va">temp</span>       <span class="op">&lt;-</span> <span class="fl">1.96</span><span class="op">*</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">vapply</a></span><span class="op">(</span><span class="va">list</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="va">B.spline</span><span class="op">[</span><span class="va">x</span>,<span class="op">]</span>,<span class="fl">1</span>,<span class="va">knot</span><span class="op">)</span><span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span><span class="va">var2</span><span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="va">B.spline</span><span class="op">[</span><span class="va">x</span>,<span class="op">]</span>,<span class="fl">1</span>,<span class="va">knot</span><span class="op">)</span><span class="op">)</span>,FUN.VALUE<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">numeric</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">low</span>        <span class="op">&lt;-</span> <span class="va">beta_t_1</span><span class="op">-</span><span class="va">temp</span></span>
<span>  <span class="va">up</span>         <span class="op">&lt;-</span> <span class="va">beta_t_1</span><span class="op">+</span><span class="va">temp</span></span>
<span>  </span>
<span>  <span class="va">beta_low</span><span class="op">[</span>,<span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">low</span></span>
<span>  <span class="va">beta_up</span><span class="op">[</span>,<span class="va">i</span><span class="op">]</span>  <span class="op">&lt;-</span> <span class="va">up</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">beta_low</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">fit</span><span class="op">$</span><span class="va">z_names</span>,<span class="st">"_low"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">beta_up</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">fit</span><span class="op">$</span><span class="va">z_names</span>,<span class="st">"_up"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">beta_low</span><span class="op">)</span></span>
<span><span class="co">#&gt;          V1_low    V2_low</span></span>
<span><span class="co">#&gt; [1,] -0.3067298 0.4644817</span></span>
<span><span class="co">#&gt; [2,] -0.3023110 0.4662445</span></span>
<span><span class="co">#&gt; [3,] -0.2857054 0.4728474</span></span>
<span><span class="co">#&gt; [4,] -0.2794734 0.4753164</span></span>
<span><span class="co">#&gt; [5,] -0.2666307 0.4803885</span></span>
<span><span class="co">#&gt; [6,] -0.2535532 0.4855309</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">beta_up</span><span class="op">)</span></span>
<span><span class="co">#&gt;         V1_up    V2_up</span></span>
<span><span class="co">#&gt; [1,] 1.221561 1.866786</span></span>
<span><span class="co">#&gt; [2,] 1.221050 1.863760</span></span>
<span><span class="co">#&gt; [3,] 1.219146 1.852390</span></span>
<span><span class="co">#&gt; [4,] 1.218438 1.848125</span></span>
<span><span class="co">#&gt; [5,] 1.216991 1.839335</span></span>
<span><span class="co">#&gt; [6,] 1.215533 1.830388</span></span></code></pre></div>
<p>matrix <code>beta_low</code> records all the lower bound of beta and
<code>beta_up</code> records all the upper bound of beta.</p>
<p>As a result, we could plot the effect by ourselves:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">beta</span>              <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="va">beta</span><span class="op">)</span></span>
<span><span class="va">beta</span>              <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">beta</span>, <span class="va">beta_low</span>, <span class="va">beta_up</span><span class="op">)</span></span>
<span><span class="va">y</span><span class="op">=</span><span class="va">beta</span><span class="op">$</span><span class="va">V2</span></span>
<span><span class="va">ymin</span><span class="op">=</span><span class="va">beta</span><span class="op">$</span><span class="va">V2_low</span></span>
<span><span class="va">ymax</span><span class="op">=</span><span class="va">beta</span><span class="op">$</span><span class="va">V2_up</span></span>
<span><span class="va">time</span><span class="op">=</span><span class="va">model_result</span><span class="op">$</span><span class="va">uniqfailtimes</span></span>
<span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">beta</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">time</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>y<span class="op">=</span> <span class="va">y</span><span class="op">)</span>,size <span class="op">=</span> <span class="fl">0.9</span>,color <span class="op">=</span> <span class="st">'red'</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html" class="external-link">geom_ribbon</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>ymin <span class="op">=</span> <span class="va">ymin</span>, ymax <span class="op">=</span> <span class="va">ymax</span><span class="op">)</span>, fill<span class="op">=</span><span class="st">"red"</span>, alpha <span class="op">=</span> <span class="fl">0.2</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_y_continuous</a></span><span class="op">(</span>name<span class="op">=</span><span class="st">'Hazard Ratio (log-scale)'</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>plot.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>hjust <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>panel.grid.major <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,panel.grid.minor <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>text<span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size<span class="op">=</span><span class="fl">14</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>axis.text<span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size<span class="op">=</span><span class="fl">14</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>axis.title.y <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>margin<span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">margin</a></span><span class="op">(</span>t<span class="op">=</span><span class="fl">0</span>, r<span class="op">=</span><span class="fl">10</span>, b<span class="op">=</span><span class="fl">0</span>, l<span class="op">=</span><span class="fl">0</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>x<span class="op">=</span><span class="st">"Time"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"Effect of V2 When holding other covariates constant"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="surtvep_files/figure-html/unnamed-chunk-12-1.png" width="672" style="display: block; margin: auto;"></p>
</div>
</div>
</div>
<div class="section level3">
<h3 id="newton-method-with-penalization">4.2 Newton Method with penalization:<a class="anchor" aria-label="anchor" href="#newton-method-with-penalization"></a>
</h3>
<p>We use the smooth spline here for penalization(default). You could
also use <code>spline="P-spline"</code>. For lambda_spline, you could
either enter a numeric number(must be an integer) or a vector of
numbers. If <code>lambda_spline</code> was entered as a vector of
numbers, the best lambda was selected based on different criteria(AIC,
TIC or GIC). If <code>lambda_spline</code> was entered as a single
number, the model result format was kind of similar as the 4.1, the
model result could be called by <code>model_result</code>. Following is
a model fit with the <code>lambda_spline</code> as a vector for
different illustration purposes:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">time</span><span class="op">=</span><span class="va">sim_data</span><span class="op">[</span>,<span class="st">"time"</span><span class="op">]</span></span>
<span><span class="va">lambda_spline_all</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.001</span>,<span class="fl">0.01</span>,<span class="fl">0.1</span>,<span class="fl">1</span>,<span class="fl">10</span>,<span class="fl">100</span>,<span class="fl">1000</span><span class="op">)</span></span>
<span><span class="va">fit_penalized</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/coxtp.html">coxtp</a></span><span class="op">(</span>event <span class="op">=</span> <span class="va">event</span>, z <span class="op">=</span> <span class="va">data</span>, time <span class="op">=</span> <span class="va">time</span>,lambda_spline<span class="op">=</span><span class="va">lambda_spline_all</span><span class="op">)</span></span></code></pre></div>
<p>The optimal lambda was saved in the model term
<code>lambda.selected</code></p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">best_lambda</span><span class="op">=</span><span class="va">fit_penalized</span><span class="op">$</span><span class="va">lambda.selected</span></span>
<span><span class="va">best_lambda</span></span>
<span><span class="co">#&gt;     value</span></span>
<span><span class="co">#&gt; AIC  1000</span></span>
<span><span class="co">#&gt; TIC   100</span></span>
<span><span class="co">#&gt; GIC  1000</span></span></code></pre></div>
<p>From the result above, we noticed that with different selection
criteria, the best lambda selected is quite different. Here, we use the
AIC criteria which set <code>lambda=1000</code>. The result for this
model was saved in related criteria model and could be called as
below:</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">AIC_model</span>  <span class="op">=</span> <span class="va">fit_penalized</span><span class="op">$</span><span class="va">model.AIC</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">AIC_model</span><span class="op">)</span></span>
<span><span class="co">#&gt;                Length Class  Mode     </span></span>
<span><span class="co">#&gt; theta             16  -none- numeric  </span></span>
<span><span class="co">#&gt; logplkd            1  -none- numeric  </span></span>
<span><span class="co">#&gt; theta_all         16  -none- numeric  </span></span>
<span><span class="co">#&gt; theta_list         3  -none- list     </span></span>
<span><span class="co">#&gt; AIC_all            1  -none- numeric  </span></span>
<span><span class="co">#&gt; TIC_all            1  -none- numeric  </span></span>
<span><span class="co">#&gt; TIC2_all           1  -none- numeric  </span></span>
<span><span class="co">#&gt; GIC_all            1  -none- numeric  </span></span>
<span><span class="co">#&gt; AIC_trace          1  -none- numeric  </span></span>
<span><span class="co">#&gt; TIC_trace          1  -none- numeric  </span></span>
<span><span class="co">#&gt; TIC2_trace         1  -none- numeric  </span></span>
<span><span class="co">#&gt; GIC_trace          1  -none- numeric  </span></span>
<span><span class="co">#&gt; logplkd_vec        1  -none- numeric  </span></span>
<span><span class="co">#&gt; SplineType         1  -none- character</span></span>
<span><span class="co">#&gt; VarianceMatrix   256  -none- numeric  </span></span>
<span><span class="co">#&gt; uniqfailtimes   2487  -none- numeric  </span></span>
<span><span class="co">#&gt; bases          19896  bs     numeric  </span></span>
<span><span class="co">#&gt; knots              4  -none- numeric</span></span></code></pre></div>
<p>We could also directly draw the plot using the following command:</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://wilkelab.org/cowplot/" class="external-link">cowplot</a></span><span class="op">)</span></span>
<span><span class="va">x</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">3</span>,length.out<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">event</span><span class="op">==</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">y1</span><span class="op">=</span><span class="fl">1</span></span>
<span><span class="va">y2</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="op">-</span><span class="fl">1.5</span><span class="op">*</span><span class="va">x</span><span class="op">)</span></span>
<span><span class="va">p1</span><span class="op">=</span><span class="fu"><a href="../reference/coxtp.plot.html">coxtp.plot</a></span><span class="op">(</span><span class="va">fit_penalized</span>,IC<span class="op">=</span><span class="st">"AIC"</span>,coef<span class="op">=</span><span class="st">"V1"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">"Penalized NR"</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">x</span>,y<span class="op">=</span><span class="va">y1</span><span class="op">)</span><span class="op">)</span> </span>
<span><span class="va">p2</span><span class="op">=</span><span class="fu"><a href="../reference/coxtp.plot.html">coxtp.plot</a></span><span class="op">(</span><span class="va">fit</span>,IC<span class="op">=</span><span class="st">"AIC"</span>,coef<span class="op">=</span><span class="st">"V1"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">"Non-Penalized NR"</span><span class="op">)</span><span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">x</span>,y<span class="op">=</span><span class="va">y1</span><span class="op">)</span><span class="op">)</span> </span>
<span><span class="fu"><a href="https://wilkelab.org/cowplot/reference/plot_grid.html" class="external-link">plot_grid</a></span><span class="op">(</span><span class="va">p1</span>,<span class="va">p2</span><span class="op">)</span></span></code></pre></div>
<p><img src="surtvep_files/figure-html/unnamed-chunk-16-1.png" width="672" style="display: block; margin: auto;"></p>
<p>Compare with the non-penalized Model, we could see that the effect of
“V1” was shrink to roughly linear in the penalized model.</p>
<p>The detail calculation of B-spline matrix, <span class="math inline">\(\theta\)</span> matrix and <span class="math inline">\(\beta\)</span> matrix was similar as that
illustrate as 4.1.2.2.</p>
</div>
</div>
<div class="section level2">
<h2 id="other-information">5. Other information<a class="anchor" aria-label="anchor" href="#other-information"></a>
</h2>
<div class="section level3">
<h3 id="backtracking-linesearch">5.1 Backtracking Linesearch<a class="anchor" aria-label="anchor" href="#backtracking-linesearch"></a>
</h3>
<p>In our packages, we provide 3 options for backtracking
linesearch(<code>btr</code>). The usual way of backtracking linesearch
is with Newton Increment(Detailed information could be found here).
However, When binary predictors with extremely low frequency are
present, the calculation of the second-order derivative has some issues.
In that case, the Newton increment presents extreme values, leading to a
huge bias. We provided a way of limiting the step size in such cases.
Instead of using the Newton increment, we use a fixed value of 1. This
method is referred to as “<code>static</code>” in our function which is
the default setting. Besides this, <code>btr="none"</code> refers to no
backtracking, and <code>btr="dynamic"</code> refers to backtracking
linesearch with Newton Increment.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># For no backtracking linesearch:</span></span>
<span><span class="va">t1</span><span class="op">=</span><span class="fu">bench</span><span class="fu">::</span><span class="fu"><a href="http://bench.r-lib.org/reference/mark.html" class="external-link">mark</a></span><span class="op">(</span><span class="fu"><a href="../reference/coxtp.html">coxtp</a></span><span class="op">(</span>event <span class="op">=</span> <span class="va">event</span>, z <span class="op">=</span> <span class="va">data</span>, </span>
<span>                  time <span class="op">=</span> <span class="va">time</span>,lambda_spline<span class="op">=</span><span class="fl">1000</span>,btr<span class="op">=</span><span class="st">"none"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#For static backtracking linesearch:</span></span>
<span><span class="va">t2</span><span class="op">=</span><span class="fu">bench</span><span class="fu">::</span><span class="fu"><a href="http://bench.r-lib.org/reference/mark.html" class="external-link">mark</a></span><span class="op">(</span><span class="fu"><a href="../reference/coxtp.html">coxtp</a></span><span class="op">(</span>event <span class="op">=</span> <span class="va">event</span>, z <span class="op">=</span> <span class="va">data</span>, </span>
<span>                  time <span class="op">=</span> <span class="va">time</span>,lambda_spline<span class="op">=</span><span class="fl">1000</span>,btr<span class="op">=</span><span class="st">"static"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#For dynamic backtracking linesearch:</span></span>
<span><span class="va">t3</span><span class="op">=</span> <span class="fu">bench</span><span class="fu">::</span><span class="fu"><a href="http://bench.r-lib.org/reference/mark.html" class="external-link">mark</a></span><span class="op">(</span><span class="fu"><a href="../reference/coxtp.html">coxtp</a></span><span class="op">(</span>event <span class="op">=</span> <span class="va">event</span>, z <span class="op">=</span> <span class="va">data</span>, </span>
<span>                  time <span class="op">=</span> <span class="va">time</span>,lambda_spline<span class="op">=</span><span class="fl">1000</span>,btr<span class="op">=</span><span class="st">"dynamic"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">t</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="va">t1</span>,<span class="va">t2</span>,<span class="va">t3</span><span class="op">)</span></span>
<span><span class="va">t</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"none"</span>,<span class="st">"static"</span>,<span class="st">"dynamic"</span><span class="op">)</span></span>
<span><span class="va">t</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 3 x 6</span></span></span>
<span><span class="co">#&gt;   expression      min   median `itr/sec` mem_alloc `gc/sec`</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>      <span style="color: #949494; font-style: italic;">&lt;bch:tm&gt;</span> <span style="color: #949494; font-style: italic;">&lt;bch:tm&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;bch:byt&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> none          1.81s    1.81s    0.551     50.8MB   0.551 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> static        4.64s    4.64s    0.215     51.6MB   0.215 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span> dynamic      10.24s   10.24s    0.097<span style="text-decoration: underline;">7</span>    52.8MB   0.097<span style="text-decoration: underline;">7</span></span></span></code></pre></div>
<p>Compared to dynamic and static, no backtracking linesearch gives the
optimal programming time. Following is the performance of each
method:</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">time_list</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">x</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">3</span>,length.out<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">event</span><span class="op">==</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">y1</span><span class="op">=</span><span class="fl">1</span></span>
<span><span class="va">y2</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="op">-</span><span class="fl">1.5</span><span class="op">*</span><span class="va">x</span><span class="op">)</span></span>
<span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">btr</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"none"</span>,<span class="st">"dynamic"</span>,<span class="st">"static"</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">fit</span><span class="op">=</span><span class="fu"><a href="../reference/coxtp.html">coxtp</a></span><span class="op">(</span>event <span class="op">=</span> <span class="va">event</span>, z <span class="op">=</span> <span class="va">data</span>, time <span class="op">=</span> <span class="va">time</span>,lambda_spline<span class="op">=</span><span class="fl">1000</span>,btr<span class="op">=</span><span class="va">btr</span><span class="op">)</span></span>
<span>  <span class="kw">for</span><span class="op">(</span><span class="va">v</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"V1"</span>,<span class="st">"V2"</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">plot</span><span class="op">=</span><span class="fu"><a href="../reference/coxtp.plot.html">coxtp.plot</a></span><span class="op">(</span><span class="va">fit</span>,IC<span class="op">=</span><span class="st">"AIC"</span>,coef<span class="op">=</span><span class="va">v</span>,ylab<span class="op">=</span><span class="st">"HR(log-scale)"</span><span class="op">)</span><span class="op">+</span> </span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>text <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">10</span><span class="op">)</span>,</span>
<span>          axis.text.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">8</span><span class="op">)</span>,</span>
<span>          axis.text.y<span class="op">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">8</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="va">v</span><span class="op">)</span></span>
<span>    <span class="kw">if</span><span class="op">(</span><span class="va">v</span><span class="op">==</span><span class="st">"V1"</span><span class="op">)</span><span class="op">{</span></span>
<span>      <span class="va">plot</span><span class="op">=</span><span class="va">plot</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">x</span>,y<span class="op">=</span><span class="va">y1</span><span class="op">)</span><span class="op">)</span> </span>
<span>    <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>      <span class="va">plot</span><span class="op">=</span><span class="va">plot</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">x</span>,y<span class="op">=</span><span class="va">y2</span><span class="op">)</span><span class="op">)</span> </span>
<span>    <span class="op">}</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/assign.html" class="external-link">assign</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"plot"</span>,<span class="va">v</span>,<span class="st">"_"</span>,<span class="va">btr</span><span class="op">)</span>,<span class="va">plot</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span><span class="op">}</span></span></code></pre></div>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://wilkelab.org/cowplot/" class="external-link">cowplot</a></span><span class="op">)</span></span>
<span><span class="co">##Plot v1</span></span>
<span><span class="va">title</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://wilkelab.org/cowplot/reference/ggdraw.html" class="external-link">ggdraw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://wilkelab.org/cowplot/reference/draw_label.html" class="external-link">draw_label</a></span><span class="op">(</span></span>
<span>    <span class="st">"Backtracking comparsion"</span>,</span>
<span>    fontface <span class="op">=</span> <span class="st">'bold'</span>,</span>
<span>    x <span class="op">=</span> <span class="fl">0</span>,</span>
<span>    hjust <span class="op">=</span> <span class="fl">0</span>,</span>
<span>    size<span class="op">=</span><span class="fl">15</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span></span>
<span>    plot.margin <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">margin</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">7</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="va">p1</span><span class="op">=</span><span class="fu"><a href="https://wilkelab.org/cowplot/reference/plot_grid.html" class="external-link">plot_grid</a></span><span class="op">(</span><span class="va">plotV1_none</span>,<span class="va">plotV2_none</span>,ncol<span class="op">=</span><span class="fl">2</span><span class="op">)</span></span>
<span><span class="va">p2</span><span class="op">=</span><span class="fu"><a href="https://wilkelab.org/cowplot/reference/plot_grid.html" class="external-link">plot_grid</a></span><span class="op">(</span><span class="va">plotV1_dynamic</span>,<span class="va">plotV2_dynamic</span>,ncol<span class="op">=</span><span class="fl">2</span><span class="op">)</span></span>
<span><span class="va">p3</span><span class="op">=</span><span class="fu"><a href="https://wilkelab.org/cowplot/reference/plot_grid.html" class="external-link">plot_grid</a></span><span class="op">(</span><span class="va">plotV1_static</span>,<span class="va">plotV2_static</span>,ncol<span class="op">=</span><span class="fl">2</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://wilkelab.org/cowplot/reference/plot_grid.html" class="external-link">plot_grid</a></span><span class="op">(</span><span class="va">title</span>,<span class="va">p1</span>,<span class="va">p2</span>,<span class="va">p3</span>,ncol<span class="op">=</span><span class="fl">1</span>,labels<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">""</span>,<span class="st">"None"</span>,<span class="st">"Dynamic"</span>,<span class="st">"Static"</span><span class="op">)</span>,rel_heights <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.1</span>,<span class="fl">1</span>,<span class="fl">1</span>,<span class="fl">1</span><span class="op">)</span>,label_size <span class="op">=</span> <span class="fl">13</span><span class="op">)</span></span></code></pre></div>
<p><img src="surtvep_files/figure-html/unnamed-chunk-19-1.png" width="672" style="display: block; margin: auto;"></p>
</div>
<div class="section level3">
<h3 id="stopping-criteria">5.2 Stopping criteria<a class="anchor" aria-label="anchor" href="#stopping-criteria"></a>
</h3>
<p>There are 4 parameters could be defined in the stopping criteria,
Convergence threshold(tol ), Maximum Iteration number(iter.max),
Stopping rule(stop), and number of steps(fixedstep). Detailed
information about stopping criteria selection could be viewed here(add
link). Following is the default setting</p>
<p><code>coxtp(...,tol=1e-6,iter.max=20L,stop="ratch",fixedstep=FALSE)</code></p>
</div>
<div class="section level3">
<h3 id="baseline-estimation">5.3 Baseline estimation<a class="anchor" aria-label="anchor" href="#baseline-estimation"></a>
</h3>
<p>The Nelson-Aalen estimator (Breslow estimator) of the culmulative
function is given by <span class="math inline">\(\widetilde{\Lambda}(t)
= \int_0^t \widetilde{\Lambda}_0(u)\)</span>, where <span class="math inline">\(\widetilde{\Lambda}(t)\)</span> is 0 except at the
observed failure times <span class="math inline">\(t_i\)</span>, where
it takes the value <span class="math display">\[\begin{align*}
    d\Lambda_0 = {d_i}\left\{\mathop{\sum}\limits_{\ell \in R(T_i)} \exp
\{\boldsymbol{X}_{i' }^T \boldsymbol{\Theta}  \boldsymbol{B}(T_{i})
\}\right\}^{-1}.
\end{align*}\]</span></p>
<p>The baseline estimation here refers to the baseline hazard at time t
when holding all the covariates equals to zero. We use the model fitted
result <code>fit_penalized</code> in section 4.2.</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">event</span><span class="op">=</span><span class="va">sim_data</span><span class="op">[</span>,<span class="st">"event"</span><span class="op">]</span></span>
<span><span class="va">time</span><span class="op">=</span><span class="va">sim_data</span><span class="op">[</span>,<span class="st">"time"</span><span class="op">]</span></span>
<span><span class="va">data</span><span class="op">=</span><span class="va">sim_data</span><span class="op">[</span>,<span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">sim_data</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"event"</span>,<span class="st">"time"</span><span class="op">)</span><span class="op">]</span></span>
<span></span>
<span></span>
<span><span class="va">model1</span>  <span class="op">=</span> <span class="va">fit_penalized</span><span class="op">$</span><span class="va">model.AIC</span></span>
<span></span>
<span><span class="co">##baseline</span></span>
<span><span class="va">plotdata</span><span class="op">=</span><span class="fu"><a href="../reference/coxtp.baseline.html">coxtp.baseline</a></span><span class="op">(</span>fit<span class="op">=</span><span class="va">model1</span>, delta<span class="op">=</span><span class="va">event</span>,z<span class="op">=</span><span class="va">data</span>,time<span class="op">=</span><span class="va">time</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">plotdata</span><span class="op">)</span></span>
<span><span class="co">#&gt;   unique.time.       lambda       Lambda</span></span>
<span><span class="co">#&gt; 1 0.0003028248 0.0001609517 0.0001609517</span></span>
<span><span class="co">#&gt; 2 0.0004273569 0.0001609879 0.0003219395</span></span>
<span><span class="co">#&gt; 3 0.0008948164 0.0000000000 0.0003219395</span></span>
<span><span class="co">#&gt; 4 0.0008981023 0.0001610787 0.0004830182</span></span>
<span><span class="co">#&gt; 5 0.0009103830 0.0000000000 0.0004830182</span></span>
<span><span class="co">#&gt; 6 0.0010759157 0.0001611453 0.0006441635</span></span></code></pre></div>
<p>Let’s check the result of baseline function first. The function
returned a dataset containing the baseline estimation including 3
variables:</p>
<ul>
<li>
<code>unique.time.</code>: The unique time listed in the original
dataset used to fit the model</li>
<li>
<code>lambda</code>: refers to <span class="math inline">\(\lambda_0(t)\)</span> in the model, which is
baseline hazard</li>
<li>
<code>Lambda</code>: refers to the cumulative baseline hazard in the
model.</li>
</ul>
<p>Note that since our baseline estimation is based on Breslow
Estimator, when there is no ties in the data, the baseline estimation
could sometime results as 0 since there is no death at certain
time-point. Thus, if we directly draw the plot, it would be something
like this:</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co">#Exclude censoring points</span></span>
<span></span>
<span><span class="va">baseline_plot</span><span class="op">&lt;-</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">plotdata</span>,<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">unique.time.</span>, y<span class="op">=</span><span class="va">lambda</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">0.6</span><span class="op">)</span> <span class="op">+</span>  </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_x_continuous</a></span><span class="op">(</span>name<span class="op">=</span><span class="st">'Years since diagnosis'</span>, limits<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">3</span><span class="op">)</span>, breaks<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1</span>,<span class="fl">2</span>,<span class="fl">3</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_y_continuous</a></span><span class="op">(</span>name<span class="op">=</span><span class="st">'baseline hazard'</span>, limits<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0.1</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">" Baseline Hazard by time"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>plot.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>hjust <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">baseline_plot</span></span></code></pre></div>
<p><img src="surtvep_files/figure-html/unnamed-chunk-21-1.png" width="672" style="display: block; margin: auto;"></p>
<p>As a result, we could either increase the time interval to make ties
exists or remove the points that have <span class="math inline">\(\lambda=0\)</span>. The only differences would
result in the baseline hazard, there is no influence on the cumulative
baseline hazard.</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">plotdata</span><span class="op">=</span><span class="va">plotdata</span><span class="op">[</span><span class="va">plotdata</span><span class="op">$</span><span class="va">lambda</span><span class="op">!=</span><span class="fl">0</span>,<span class="op">]</span></span></code></pre></div>
<p>Next, we are going to visualize the result using <code>ggplot2</code>
and <code>cowplot</code> function.</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co">#Exclude censoring points</span></span>
<span></span>
<span><span class="va">baseline_plot</span><span class="op">&lt;-</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">plotdata</span>,<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">unique.time.</span>, y<span class="op">=</span><span class="va">lambda</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">0.6</span><span class="op">)</span> <span class="op">+</span>  </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_x_continuous</a></span><span class="op">(</span>name<span class="op">=</span><span class="st">'Years since diagnosis'</span>, limits<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">3</span><span class="op">)</span>, breaks<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1</span>,<span class="fl">2</span>,<span class="fl">3</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_y_continuous</a></span><span class="op">(</span>name<span class="op">=</span><span class="st">'baseline hazard'</span>, limits<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0.1</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">" Baseline Hazard by time"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>plot.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>hjust <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">cum_plot</span><span class="op">&lt;-</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">plotdata</span>,<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">unique.time.</span>, y<span class="op">=</span><span class="va">Lambda</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">0.6</span><span class="op">)</span> <span class="op">+</span>  </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_x_continuous</a></span><span class="op">(</span>name<span class="op">=</span><span class="st">'Years since diagnosis'</span>, limits<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">3</span><span class="op">)</span>, breaks<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1</span>,<span class="fl">2</span>,<span class="fl">3</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_y_continuous</a></span><span class="op">(</span>name<span class="op">=</span><span class="st">'Cumulative baseline hazard'</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">"Cumulative Baseline Hazard by time"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>plot.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>hjust <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://wilkelab.org/cowplot/reference/plot_grid.html" class="external-link">plot_grid</a></span><span class="op">(</span><span class="va">baseline_plot</span>,<span class="va">cum_plot</span>,ncol <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<p><img src="surtvep_files/figure-html/unnamed-chunk-23-1.png" width="672" style="display: block; margin: auto;"></p>
<p>One use of Cumulative baseline hazard is to calculate the survival
function where cumulative hazard is the negative log of the survival
probabilities. If we assume cumulative baseline hazard function as <span class="math inline">\(S(t)\)</span> and cumulative hazard function as
<span class="math inline">\(H(t)\)</span>, then we have <span class="math inline">\(H(t)=-log(S(t))\)</span>. Thus, we could plot the
survival function as follows:</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">plotdata</span><span class="op">$</span><span class="va">survive</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="op">-</span><span class="va">plotdata</span><span class="op">$</span><span class="va">Lambda</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">plotdata</span>,<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">unique.time.</span>, y<span class="op">=</span><span class="va">survive</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">0.6</span><span class="op">)</span> <span class="op">+</span>  </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_x_continuous</a></span><span class="op">(</span>name<span class="op">=</span><span class="st">'Years since diagnosis'</span>, limits<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">3</span><span class="op">)</span>, breaks<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1</span>,<span class="fl">2</span>,<span class="fl">3</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_y_continuous</a></span><span class="op">(</span>name<span class="op">=</span><span class="st">'Survival Function'</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">"Survival by time"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>plot.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>hjust <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="surtvep_files/figure-html/unnamed-chunk-24-1.png" width="672" style="display: block; margin: auto;"></p>
</div>
<div class="section level3">
<h3 id="testing-for-time-varying-effect">5.4 Testing for time-varying effect<a class="anchor" aria-label="anchor" href="#testing-for-time-varying-effect"></a>
</h3>
</div>
<div class="section level3">
<h3 id="stratification">5.5 Stratification<a class="anchor" aria-label="anchor" href="#stratification"></a>
</h3>
<p>To handle different stratification groups in the dataset, the
packages will use each facility as its own risk sets and finish the
estimation. To add strata in the model, simply use the
<code>strata</code> option. Following is an example:</p>
<p>Here, we are using the sim_data_p5_f5 as example.</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sim_data_p5_f5</span><span class="op">=</span><span class="va">sim_data_p5_f5</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">sim_data_p5_f5</span><span class="op">)</span></span>
<span><span class="co">#&gt;      V1 V2 V3 V4 V5 event         time facility</span></span>
<span><span class="co">#&gt; [1,]  0  0  0  0  0     0 4.018354e-05        2</span></span>
<span><span class="co">#&gt; [2,]  0  0  1  1  1     1 2.103197e-04        2</span></span>
<span><span class="co">#&gt; [3,]  0  0  0  1  1     1 2.281676e-04        5</span></span>
<span><span class="co">#&gt; [4,]  0  0  0  0  1     1 4.334258e-04        3</span></span>
<span><span class="co">#&gt; [5,]  0  0  0  1  1     1 5.608086e-04        4</span></span>
<span><span class="co">#&gt; [6,]  1  0  0  0  0     1 5.623171e-04        1</span></span></code></pre></div>
<p>The dataset have 5 covariates, “V1” to “V5”, and a strata variable,
“facility”. For this dataset, the true time-dependent function is</p>
<ul>
<li>V1: <span class="math inline">\(\beta(t)=1\)</span><br>
</li>
<li>V2: <span class="math inline">\(\beta(t)=sin(3*\pi*t/4)\)</span><br>
</li>
<li>V3: <span class="math inline">\(\beta(t)=-1\)</span><br>
</li>
<li>V4: <span class="math inline">\(\beta(t)=(t/3)**2*exp(t/2)\)</span><br>
</li>
<li>V5: <span class="math inline">\(\beta(t)=exp(-1.5*t)\)</span>
</li>
</ul>
<p>Now, let’s fit the model by simply add one option
<code>strata =facility</code>. The black line in the plot refers to the
true function while the red line and area refers to the estimated
function and its 95% CI. Again, we assume the best
<code>lambda_spline=1000</code></p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#Extract data</span></span>
<span><span class="va">event_stra</span><span class="op">=</span><span class="va">sim_data_p5_f5</span><span class="op">[</span>,<span class="st">"event"</span><span class="op">]</span></span>
<span><span class="va">time_stra</span><span class="op">=</span><span class="va">sim_data_p5_f5</span><span class="op">[</span>,<span class="st">"time"</span><span class="op">]</span></span>
<span><span class="va">data_stra</span><span class="op">=</span><span class="va">sim_data_p5_f5</span><span class="op">[</span>,<span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">sim_data_p5_f5</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"event"</span>,<span class="st">"time"</span>,<span class="st">"facility"</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="va">facility</span><span class="op">=</span><span class="va">sim_data_p5_f5</span><span class="op">[</span>,<span class="st">"facility"</span><span class="op">]</span></span>
<span></span>
<span><span class="co">#select best lambda</span></span>
<span><span class="co"># lambda_spline_all=c(0.001,0.01,0.1,1,10,100,1000)</span></span>
<span><span class="co"># fit_stra&lt;-coxtp(event=event_stra,z=data_stra,time=time_stra,strata =facility,lambda_spline=lambda_spline_all)</span></span>
<span></span>
<span><span class="va">lambda_spline</span><span class="op">=</span><span class="fl">1000</span></span>
<span><span class="va">fit_stra</span><span class="op">&lt;-</span><span class="fu"><a href="../reference/coxtp.html">coxtp</a></span><span class="op">(</span>event<span class="op">=</span><span class="va">event_stra</span>,z<span class="op">=</span><span class="va">data_stra</span>,time<span class="op">=</span><span class="va">time_stra</span>,strata <span class="op">=</span><span class="va">facility</span>,lambda_spline<span class="op">=</span><span class="va">lambda_spline</span><span class="op">)</span></span></code></pre></div>
<p>Again, we use the <code>coxtp.baseline</code> function to get the
baseline estimation for different group. Just add the option
<code>strata=facility</code> to get specific facility data</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="va">model1</span>  <span class="op">=</span> <span class="va">fit_stra</span><span class="op">$</span><span class="va">model_result</span></span>
<span><span class="va">baselinedata</span><span class="op">=</span><span class="fu"><a href="../reference/coxtp.baseline.html">coxtp.baseline</a></span><span class="op">(</span>fit<span class="op">=</span><span class="va">model1</span>, delta<span class="op">=</span><span class="va">event_stra</span>,z<span class="op">=</span><span class="va">data_stra</span>,time<span class="op">=</span><span class="va">time_stra</span>,strata <span class="op">=</span> <span class="va">facility</span><span class="op">)</span></span>
<span><span class="va">baselinedata</span><span class="op">=</span><span class="va">baselinedata</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">lambda</span><span class="op">!=</span><span class="fl">0</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>facility<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="va">strata</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">baseline_plot</span><span class="op">&lt;-</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">baselinedata</span>,<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">unique.time_temp.</span>, y<span class="op">=</span><span class="va">lambda</span>,group<span class="op">=</span><span class="va">facility</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">0.6</span>,<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>color<span class="op">=</span><span class="va">facility</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>  </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_x_continuous</a></span><span class="op">(</span>name<span class="op">=</span><span class="st">'Years since diagnosis'</span>, limits<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">3</span><span class="op">)</span>, breaks<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1</span>,<span class="fl">2</span>,<span class="fl">3</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_y_continuous</a></span><span class="op">(</span>name<span class="op">=</span><span class="st">'baseline hazard'</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">" Baseline Hazard by time and facility"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>plot.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>hjust <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">baseline_plot</span></span></code></pre></div>
<p><img src="surtvep_files/figure-html/unnamed-chunk-27-1.png" width="672" style="display: block; margin: auto;"></p>
</div>
<div class="section level3">
<h3 id="model-prediction">5.6 Model prediction:<a class="anchor" aria-label="anchor" href="#model-prediction"></a>
</h3>
<div class="section level4">
<h4 id="simple-prediction">5.6.1 Simple prediction<a class="anchor" aria-label="anchor" href="#simple-prediction"></a>
</h4>
<p>To predict the new data, we offered the function coxtp.predict. This
function could also be used to calculate absolute hazard. Suppose the
new data to be predicted is <code>c(1,1,0,0,0)</code> for
<code>V1</code> to <code>V5</code>. For data with no stratification:
(Suppose we already have the best tuning parameter
<code>lambda_spline</code> selected).</p>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sim_data</span><span class="op">=</span><span class="va">sim_data_p5</span></span>
<span><span class="va">event</span><span class="op">=</span><span class="va">sim_data</span><span class="op">[</span>,<span class="st">"event"</span><span class="op">]</span></span>
<span><span class="va">time</span><span class="op">=</span><span class="va">sim_data</span><span class="op">[</span>,<span class="st">"time"</span><span class="op">]</span></span>
<span><span class="va">data</span><span class="op">=</span><span class="va">sim_data</span><span class="op">[</span>,<span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">sim_data</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"event"</span>,<span class="st">"time"</span><span class="op">)</span><span class="op">]</span></span>
<span></span>
<span><span class="va">lambda_spline</span><span class="op">=</span><span class="fl">1000</span></span>
<span><span class="va">fit_penalized</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/coxtp.html">coxtp</a></span><span class="op">(</span>event <span class="op">=</span> <span class="va">event</span>, z <span class="op">=</span> <span class="va">data</span>, time <span class="op">=</span> <span class="va">time</span>,lambda_spline<span class="op">=</span><span class="va">lambda_spline</span><span class="op">)</span></span>
<span></span>
<span><span class="va">model_result</span>  <span class="op">=</span> <span class="va">fit_penalized</span><span class="op">$</span><span class="va">model_result</span></span>
<span><span class="va">baseline</span><span class="op">=</span><span class="fu"><a href="../reference/coxtp.baseline.html">coxtp.baseline</a></span><span class="op">(</span>fit<span class="op">=</span><span class="va">model_result</span>, delta<span class="op">=</span><span class="va">event</span>,z<span class="op">=</span><span class="va">data</span>,time<span class="op">=</span><span class="va">time</span><span class="op">)</span></span>
<span><span class="va">data_predict</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">1</span>,<span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">predict</span><span class="op">=</span><span class="fu"><a href="../reference/coxtp.predict.html">coxtp.predict</a></span><span class="op">(</span><span class="va">model_result</span>,<span class="va">baseline</span>,newdata<span class="op">=</span><span class="va">data_predict</span><span class="op">)</span></span></code></pre></div>
<p>The result dataset <code>predict</code> is a dataset with predicted
hazard and time points in the orginal dataset. We could plot the data
using ggplot:</p>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">predict</span>,<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">unique.time.</span>,y<span class="op">=</span><span class="va">lambda0_exp_betax</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">0.6</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_x_continuous</a></span><span class="op">(</span>name<span class="op">=</span><span class="st">'Years since diagnosis'</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_y_continuous</a></span><span class="op">(</span>name<span class="op">=</span><span class="st">'Predicted hazard'</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">"Predicted Hazard"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>plot.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>hjust <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="surtvep_files/figure-html/unnamed-chunk-29-1.png" width="672" style="display: block; margin: auto;"></p>
</div>
<div class="section level4">
<h4 id="absolute-hazard">5.6.2 absolute hazard<a class="anchor" aria-label="anchor" href="#absolute-hazard"></a>
</h4>
<p>If we want to calculate and show the difference of absolute hazard
for variable <code>V2</code>, we could use the
<code>coxtp.predict</code> to get it done. Assume that besides
<code>V2</code>, other covariate are all set to the reference level.</p>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">data_predict0</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1</span>,<span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">predict0</span><span class="op">=</span><span class="fu"><a href="../reference/coxtp.predict.html">coxtp.predict</a></span><span class="op">(</span><span class="va">model_result</span>,<span class="va">baseline</span>,newdata<span class="op">=</span><span class="va">data_predict0</span>,strata <span class="op">=</span> <span class="cn">F</span><span class="op">)</span></span>
<span><span class="va">data_predict1</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">predict1</span><span class="op">=</span><span class="fu"><a href="../reference/coxtp.predict.html">coxtp.predict</a></span><span class="op">(</span><span class="va">model_result</span>,<span class="va">baseline</span>,newdata<span class="op">=</span><span class="va">data_predict1</span>,strata <span class="op">=</span> <span class="cn">F</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">predict0</span><span class="op">$</span><span class="va">unique.time.</span>,y<span class="op">=</span><span class="va">predict0</span><span class="op">$</span><span class="va">lambda0_exp_betax</span>,color<span class="op">=</span><span class="st">"V2=0"</span><span class="op">)</span>,size <span class="op">=</span> <span class="fl">0.6</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">predict1</span><span class="op">$</span><span class="va">unique.time.</span>,y<span class="op">=</span><span class="va">predict1</span><span class="op">$</span><span class="va">lambda0_exp_betax</span>,color<span class="op">=</span><span class="st">"V2=1"</span><span class="op">)</span>,size <span class="op">=</span> <span class="fl">0.6</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_x_continuous</a></span><span class="op">(</span>name<span class="op">=</span><span class="st">'Years since diagnosis'</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_y_continuous</a></span><span class="op">(</span>name<span class="op">=</span><span class="st">'Predicted hazard'</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">"Predicted Hazard"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>plot.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>hjust <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="surtvep_files/figure-html/unnamed-chunk-30-1.png" width="672" style="display: block; margin: auto;"></p>
</div>
<div class="section level4">
<h4 id="prediction-for-certain-time-points">5.6.3 Prediction for certain time points<a class="anchor" aria-label="anchor" href="#prediction-for-certain-time-points"></a>
</h4>
<p>Also, we could specify the time points of output by define
<code>out_seq</code>. Following is an example:</p>
<p>Let’s check the output first:</p>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">predict_seq</span><span class="op">=</span><span class="fu"><a href="../reference/coxtp.predict.html">coxtp.predict</a></span><span class="op">(</span><span class="va">model_result</span>,<span class="va">baseline</span>,newdata<span class="op">=</span><span class="va">data_predict</span>,strata <span class="op">=</span> <span class="cn">F</span>,out_seq<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">3</span>,by<span class="op">=</span><span class="fl">0.5</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">predict_seq</span></span>
<span><span class="co">#&gt;   unique.time. lambda0_exp_betax</span></span>
<span><span class="co">#&gt; 1          0.0      0.0006728946</span></span>
<span><span class="co">#&gt; 2          0.5      0.0015034094</span></span>
<span><span class="co">#&gt; 3          1.0      0.0028342667</span></span>
<span><span class="co">#&gt; 4          1.5      0.0050570834</span></span>
<span><span class="co">#&gt; 5          2.0      0.0100623208</span></span>
<span><span class="co">#&gt; 6          2.5      0.0259174910</span></span>
<span><span class="co">#&gt; 7          3.0      0.1464175450</span></span></code></pre></div>
<p>Instead of outputing all the data points, the
<code>coxtp.predict</code> will only output the time points that has
been specified. Next, we are going to see if there is any difference
between the one with default output and the one with specified time
points:</p>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">predict_seq</span><span class="op">=</span><span class="fu"><a href="../reference/coxtp.predict.html">coxtp.predict</a></span><span class="op">(</span><span class="va">model_result</span>,<span class="va">baseline</span>,newdata<span class="op">=</span><span class="va">data_predict</span>,strata <span class="op">=</span> <span class="cn">F</span>,out_seq<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">3</span>,by<span class="op">=</span><span class="fl">0.1</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">plot_or</span><span class="op">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">predict</span>,<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">unique.time.</span>,y<span class="op">=</span><span class="va">lambda0_exp_betax</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>          <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">0.6</span><span class="op">)</span> <span class="op">+</span> </span>
<span>          <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_x_continuous</a></span><span class="op">(</span>name<span class="op">=</span><span class="st">'Years since diagnosis'</span><span class="op">)</span> <span class="op">+</span> </span>
<span>          <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_y_continuous</a></span><span class="op">(</span>name<span class="op">=</span><span class="st">'Predicted hazard'</span><span class="op">)</span> <span class="op">+</span></span>
<span>          <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">"Without specify out_seq"</span><span class="op">)</span> <span class="op">+</span></span>
<span>          <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>plot.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>hjust <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">plot_seq</span><span class="op">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">predict_seq</span>,<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">unique.time.</span>,y<span class="op">=</span><span class="va">lambda0_exp_betax</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>          <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">0.6</span><span class="op">)</span> <span class="op">+</span> </span>
<span>          <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_x_continuous</a></span><span class="op">(</span>name<span class="op">=</span><span class="st">'Years since diagnosis'</span><span class="op">)</span> <span class="op">+</span> </span>
<span>          <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_y_continuous</a></span><span class="op">(</span>name<span class="op">=</span><span class="st">'Predicted hazard'</span><span class="op">)</span> <span class="op">+</span></span>
<span>          <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">"With specify out_seq"</span><span class="op">)</span> <span class="op">+</span></span>
<span>          <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>plot.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>hjust <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://wilkelab.org/cowplot/reference/plot_grid.html" class="external-link">plot_grid</a></span><span class="op">(</span><span class="va">plot_or</span>,<span class="va">plot_seq</span>,ncol <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<p><img src="surtvep_files/figure-html/unnamed-chunk-32-1.png" width="672" style="display: block; margin: auto;">
From the result above, we could notice that only the function smoothness
looks different.</p>
</div>
<div class="section level4">
<h4 id="prediction-with-stratification">5.6.3 Prediction with stratification<a class="anchor" aria-label="anchor" href="#prediction-with-stratification"></a>
</h4>
<p>For data with stratification, just define that
<code>strata=T</code>(Default is FALSE):(Again, suppose we already have
the best tuning parameter lambda selected)</p>
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">event_stra</span><span class="op">=</span><span class="va">sim_data_p5_f5</span><span class="op">[</span>,<span class="st">"event"</span><span class="op">]</span></span>
<span><span class="va">time_stra</span><span class="op">=</span><span class="va">sim_data_p5_f5</span><span class="op">[</span>,<span class="st">"time"</span><span class="op">]</span></span>
<span><span class="va">data_stra</span><span class="op">=</span><span class="va">sim_data_p5_f5</span><span class="op">[</span>,<span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">sim_data_p5_f5</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"event"</span>,<span class="st">"time"</span>,<span class="st">"facility"</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="va">facility</span><span class="op">=</span><span class="va">sim_data_p5_f5</span><span class="op">[</span>,<span class="st">"facility"</span><span class="op">]</span></span>
<span></span>
<span><span class="co">#select best lambda</span></span>
<span><span class="va">lambda_spline</span><span class="op">=</span><span class="fl">1000</span></span>
<span><span class="va">fit_stra</span><span class="op">&lt;-</span><span class="fu"><a href="../reference/coxtp.html">coxtp</a></span><span class="op">(</span>event<span class="op">=</span><span class="va">event_stra</span>,z<span class="op">=</span><span class="va">data_stra</span>,time<span class="op">=</span><span class="va">time_stra</span>,strata <span class="op">=</span><span class="va">facility</span>,lambda_spline<span class="op">=</span><span class="va">lambda_spline</span><span class="op">)</span></span>
<span><span class="va">model_result</span>  <span class="op">=</span> <span class="va">fit_stra</span><span class="op">$</span><span class="va">model_result</span></span>
<span><span class="va">baseline_strata</span><span class="op">=</span><span class="fu"><a href="../reference/coxtp.baseline.html">coxtp.baseline</a></span><span class="op">(</span>fit<span class="op">=</span><span class="va">model_result</span>, delta<span class="op">=</span><span class="va">event_stra</span>,z<span class="op">=</span><span class="va">data_stra</span>,time<span class="op">=</span><span class="va">time_stra</span>,strata <span class="op">=</span> <span class="va">facility</span><span class="op">)</span></span>
<span><span class="va">data_predict</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">1</span>,<span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">predict</span><span class="op">=</span><span class="fu"><a href="../reference/coxtp.predict.html">coxtp.predict</a></span><span class="op">(</span><span class="va">model_result</span>,<span class="va">baseline_strata</span>,newdata<span class="op">=</span><span class="va">data_predict</span>,strata <span class="op">=</span> <span class="cn">T</span><span class="op">)</span></span></code></pre></div>
<p>Again, we could plot the result by ggplot:</p>
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">predict</span>,<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">unique.time.</span>,y<span class="op">=</span><span class="va">lambda0_exp_betax</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>color<span class="op">=</span><span class="va">strata</span>,group<span class="op">=</span><span class="va">strata</span><span class="op">)</span>,size <span class="op">=</span> <span class="fl">0.6</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_x_continuous</a></span><span class="op">(</span>name<span class="op">=</span><span class="st">'Years since diagnosis'</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_y_continuous</a></span><span class="op">(</span>name<span class="op">=</span><span class="st">'Predicted hazard'</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">"Predicted Hazard"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>plot.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>hjust <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="surtvep_files/figure-html/unnamed-chunk-34-1.png" width="672" style="display: block; margin: auto;"></p>
</div>
</div>
</div>
<div class="section level2">
<h2 id="model-performance">6. Model performance<a class="anchor" aria-label="anchor" href="#model-performance"></a>
</h2>
<div class="section level3">
<h3 id="internal-comparison">6.1 Internal comparison<a class="anchor" aria-label="anchor" href="#internal-comparison"></a>
</h3>
<div class="section level4">
<h4 id="accurancy">6.6.1 Accurancy:<a class="anchor" aria-label="anchor" href="#accurancy"></a>
</h4>
<p>For the non-penalized method, the estimation is largely depended on
the number of knots chosen in the B-Spline base function. The example
shown above is using the default knots, which is <code>nspline=8</code>.
However, the estimation could be largely different if we choose other
knots. Following is the code showing the performance of the estimation
when choosing different knots:</p>
<p>Following is the code showing the performance of the estimation when
choosing different knots:</p>
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sim_data</span><span class="op">=</span><span class="fu">surtvep</span><span class="fu">::</span><span class="va"><a href="../reference/sim_data.html">sim_data</a></span></span>
<span><span class="va">event</span><span class="op">=</span><span class="va">sim_data</span><span class="op">[</span>,<span class="st">"event"</span><span class="op">]</span></span>
<span><span class="va">time</span><span class="op">=</span><span class="va">sim_data</span><span class="op">[</span>,<span class="st">"time"</span><span class="op">]</span></span>
<span><span class="va">data</span><span class="op">=</span><span class="va">sim_data</span><span class="op">[</span>,<span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">sim_data</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"event"</span>,<span class="st">"time"</span><span class="op">)</span><span class="op">]</span></span>
<span></span>
<span><span class="va">knot_list</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">6</span>,<span class="fl">8</span>,<span class="fl">10</span>,<span class="fl">20</span><span class="op">)</span></span>
<span><span class="va">labels</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"Knots="</span>,<span class="va">knot_list</span><span class="op">)</span></span>
<span><span class="va">x</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">3</span>,length.out<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">event</span><span class="op">==</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">y</span><span class="op">=</span><span class="fl">1</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">knot</span> <span class="kw">in</span> <span class="va">knot_list</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">fit</span><span class="op">&lt;-</span><span class="fu"><a href="../reference/coxtp.html">coxtp</a></span><span class="op">(</span>event<span class="op">=</span><span class="va">event</span>,z<span class="op">=</span><span class="va">data</span>,time<span class="op">=</span><span class="va">time</span>,nspline<span class="op">=</span><span class="va">knot</span><span class="op">)</span></span>
<span>  <span class="va">plot</span><span class="op">&lt;-</span><span class="fu"><a href="../reference/coxtp.plot.html">coxtp.plot</a></span><span class="op">(</span><span class="va">fit</span>,coef<span class="op">=</span><span class="st">"V1"</span>,ylab<span class="op">=</span><span class="st">"HR(log-scale)"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>text <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">10</span><span class="op">)</span>,</span>
<span>          axis.text.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">8</span><span class="op">)</span>,</span>
<span>          axis.text.y<span class="op">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">8</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">""</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">x</span>,y<span class="op">=</span><span class="va">y</span><span class="op">)</span><span class="op">)</span>   </span>
<span>  <span class="va">plot</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/assign.html" class="external-link">assign</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"plot"</span>,<span class="va">knot</span><span class="op">)</span>,<span class="va">plot</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://wilkelab.org/cowplot/" class="external-link">cowplot</a></span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="va">title</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://wilkelab.org/cowplot/reference/ggdraw.html" class="external-link">ggdraw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://wilkelab.org/cowplot/reference/draw_label.html" class="external-link">draw_label</a></span><span class="op">(</span></span>
<span>    <span class="st">"Non-penalized NR"</span>,</span>
<span>    fontface <span class="op">=</span> <span class="st">'bold'</span>,</span>
<span>    x <span class="op">=</span> <span class="fl">0</span>,</span>
<span>    hjust <span class="op">=</span> <span class="fl">0</span>,</span>
<span>    size<span class="op">=</span><span class="fl">15</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span></span>
<span>    plot.margin <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">margin</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">7</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">p1</span><span class="op">=</span><span class="fu"><a href="https://wilkelab.org/cowplot/reference/plot_grid.html" class="external-link">plot_grid</a></span><span class="op">(</span><span class="va">plot6</span>,<span class="va">plot8</span>,<span class="va">plot10</span>,<span class="va">plot20</span>,ncol<span class="op">=</span><span class="fl">2</span>,labels<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">labels</span><span class="op">)</span>,label_size <span class="op">=</span> <span class="fl">13</span><span class="op">)</span></span>
<span><span class="va">p1</span></span></code></pre></div>
<p><img src="surtvep_files/figure-html/unnamed-chunk-36-1.png" width="672" style="display: block; margin: auto;">
For the result above, the red line and shadow refer to the estimated
function and 95%CI while the black line refers to the true function
which is time-fixed(y=1). From the result above, we noticed that as the
knots increase, the estimation becomes more and more inaccurate. This is
happening because as the number of knots increases, the variance in the
data was mistakenly captured as its influence. This makes the number of
knots of selection in the non-penalized model very important.</p>
<p>While for penalized model, since we have penalized term, the number
of knots didn’t matters much, instead, the <span class="math inline">\(\lambda\)</span> is more important. Following plot
is the performance of estimation when we use the lambda_spline selected
before, which is <code>lambda_spline= 1000</code></p>
<div class="sourceCode" id="cb37"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">knot_list</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">6</span>,<span class="fl">8</span>,<span class="fl">10</span>,<span class="fl">20</span><span class="op">)</span></span>
<span><span class="va">labels</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"Knots="</span>,<span class="va">knot_list</span><span class="op">)</span></span>
<span><span class="va">x</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">3</span>,length.out<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">event</span><span class="op">==</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">y</span><span class="op">=</span><span class="fl">1</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">knot</span> <span class="kw">in</span> <span class="va">knot_list</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">fit</span><span class="op">&lt;-</span><span class="fu"><a href="../reference/coxtp.html">coxtp</a></span><span class="op">(</span>event<span class="op">=</span><span class="va">event</span>,z<span class="op">=</span><span class="va">data</span>,time<span class="op">=</span><span class="va">time</span>,nspline<span class="op">=</span><span class="va">knot</span>,lambda_spline <span class="op">=</span> <span class="fl">1000</span><span class="op">)</span></span>
<span>  <span class="va">plot</span><span class="op">&lt;-</span><span class="fu"><a href="../reference/coxtp.plot.html">coxtp.plot</a></span><span class="op">(</span><span class="va">fit</span>,coef<span class="op">=</span><span class="st">"V1"</span>,ylab<span class="op">=</span><span class="st">"HR(log-scale)"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>text <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">10</span><span class="op">)</span>,</span>
<span>          axis.text.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">8</span><span class="op">)</span>,</span>
<span>          axis.text.y<span class="op">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">8</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">""</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">x</span>,y<span class="op">=</span><span class="va">y</span><span class="op">)</span><span class="op">)</span> </span>
<span>  <span class="va">plot</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/assign.html" class="external-link">assign</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"plot"</span>,<span class="va">knot</span><span class="op">)</span>,<span class="va">plot</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<div class="sourceCode" id="cb38"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://wilkelab.org/cowplot/" class="external-link">cowplot</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">title</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://wilkelab.org/cowplot/reference/ggdraw.html" class="external-link">ggdraw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://wilkelab.org/cowplot/reference/draw_label.html" class="external-link">draw_label</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"Penalized NR,lambda="</span>,<span class="fl">1000</span><span class="op">)</span>,</span>
<span>    fontface <span class="op">=</span> <span class="st">'bold'</span>,</span>
<span>    x <span class="op">=</span> <span class="fl">0</span>,</span>
<span>    hjust <span class="op">=</span> <span class="fl">0</span>,</span>
<span>    size<span class="op">=</span><span class="fl">15</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span></span>
<span>    plot.margin <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">margin</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">7</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="va">p1</span><span class="op">=</span><span class="fu"><a href="https://wilkelab.org/cowplot/reference/plot_grid.html" class="external-link">plot_grid</a></span><span class="op">(</span><span class="va">plot6</span>,<span class="va">plot8</span>,<span class="va">plot10</span>,<span class="va">plot20</span>,ncol<span class="op">=</span><span class="fl">2</span>,labels<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">labels</span><span class="op">)</span>,label_size <span class="op">=</span> <span class="fl">13</span><span class="op">)</span></span>
<span><span class="va">p1</span></span></code></pre></div>
<p><img src="surtvep_files/figure-html/unnamed-chunk-38-1.png" width="672" style="display: block; margin: auto;">
From the plot above, we could observe that with different knots
selected, the performance is not different so much for different knots,
all the estimates are relatively close to the real function. However, in
the penalized model, the lambda is more important which is another
reason that we need to select the best lambda before actually fitting
the model. The following plot is the performance of different lambda
selected. For the following plot, the knot was set as default, which is
<code>knot=8</code>.</p>
<div class="sourceCode" id="cb39"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">lambda_spline_all</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.001</span>,<span class="fl">0.01</span>,<span class="fl">0.1</span>,<span class="fl">1</span>,<span class="fl">10</span>,<span class="fl">100</span><span class="op">)</span></span>
<span><span class="va">labels</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"lambda="</span>,<span class="va">lambda_spline_all</span><span class="op">)</span></span>
<span><span class="va">i</span><span class="op">=</span><span class="fl">1</span></span>
<span><span class="va">x</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">3</span>,length.out<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">event</span><span class="op">==</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">y</span><span class="op">=</span><span class="fl">1</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">lambda</span> <span class="kw">in</span> <span class="va">lambda_spline_all</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">fit</span><span class="op">&lt;-</span><span class="fu"><a href="../reference/coxtp.html">coxtp</a></span><span class="op">(</span>event<span class="op">=</span><span class="va">event</span>,z<span class="op">=</span><span class="va">data</span>,time<span class="op">=</span><span class="va">time</span>,lambda_spline <span class="op">=</span> <span class="va">lambda</span><span class="op">)</span></span>
<span>  <span class="va">plot</span><span class="op">&lt;-</span><span class="fu"><a href="../reference/coxtp.plot.html">coxtp.plot</a></span><span class="op">(</span><span class="va">fit</span>,coef<span class="op">=</span><span class="st">"V1"</span>,ylab<span class="op">=</span><span class="st">"HR(log-scale)"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>text <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">10</span><span class="op">)</span>,</span>
<span>          axis.text.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">8</span><span class="op">)</span>,</span>
<span>          axis.text.y<span class="op">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">8</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">""</span><span class="op">)</span>  <span class="op">+</span> </span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">x</span>,y<span class="op">=</span><span class="va">y</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">plot</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/assign.html" class="external-link">assign</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"plot"</span>,<span class="va">i</span><span class="op">)</span>,<span class="va">plot</span><span class="op">)</span></span>
<span>  <span class="va">i</span><span class="op">=</span><span class="va">i</span><span class="op">+</span><span class="fl">1</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://wilkelab.org/cowplot/" class="external-link">cowplot</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">title</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://wilkelab.org/cowplot/reference/ggdraw.html" class="external-link">ggdraw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://wilkelab.org/cowplot/reference/draw_label.html" class="external-link">draw_label</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"Penalized NR,knot="</span>,<span class="fl">8</span><span class="op">)</span>,</span>
<span>    fontface <span class="op">=</span> <span class="st">'bold'</span>,</span>
<span>    x <span class="op">=</span> <span class="fl">0</span>,</span>
<span>    hjust <span class="op">=</span> <span class="fl">0</span>,</span>
<span>    size<span class="op">=</span><span class="fl">15</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span></span>
<span>    plot.margin <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">margin</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">7</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb40"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">p1</span><span class="op">=</span><span class="fu"><a href="https://wilkelab.org/cowplot/reference/plot_grid.html" class="external-link">plot_grid</a></span><span class="op">(</span><span class="va">plot1</span>,<span class="va">plot2</span>,<span class="va">plot3</span>,<span class="va">plot4</span>,<span class="va">plot5</span>,<span class="va">plot6</span>,ncol<span class="op">=</span><span class="fl">2</span>,labels<span class="op">=</span><span class="va">labels</span>,label_size <span class="op">=</span> <span class="fl">13</span><span class="op">)</span></span>
<span><span class="va">p1</span></span></code></pre></div>
<p><img src="surtvep_files/figure-html/unnamed-chunk-40-1.png" width="672" style="display: block; margin: auto;">
As a result, as the lambda increase, the estimated function is more
related to the true function. This is happening because that the true
function is time-fixed function, thus, as the lambda increase, the real
function tends to shrink to the fixed function.</p>
</div>
<div class="section level4">
<h4 id="efficacy">6.1.2 Efficacy<a class="anchor" aria-label="anchor" href="#efficacy"></a>
</h4>
<p>Next, we are going to compare the Efficacy of different methods. The
main function we used to eliminate computation time by parallel. For the
function, the default setting for parallel is
<code>parallel=FALSE</code>. For parallel computation, we also need to
define <code>threads</code>, which refers to the number of cores of the
computer. Here we set <code>thread=4</code>. The following code and plot
is to use to compare parallel and non-parallel time for different sample
size:</p>
<div class="sourceCode" id="cb41"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://stringi.gagolewski.com/" class="external-link">stringi</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="http://stringr.tidyverse.org" class="external-link">stringr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="va">samplesize_list</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1000</span>,<span class="fl">2000</span>,<span class="fl">3000</span>,<span class="fl">4000</span>,<span class="fl">5000</span><span class="op">)</span></span>
<span><span class="va">i</span><span class="op">=</span><span class="fl">1</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">samplesize</span> <span class="kw">in</span> <span class="va">samplesize_list</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">i</span><span class="op">)</span></span>
<span>  <span class="va">sim_data_sub</span><span class="op">=</span><span class="va">sim_data</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="va">samplesize</span>,<span class="op">]</span></span>
<span>  <span class="va">event_sub</span><span class="op">=</span><span class="va">sim_data_sub</span><span class="op">[</span>,<span class="st">"event"</span><span class="op">]</span></span>
<span>  <span class="va">time_sub</span><span class="op">=</span><span class="va">sim_data_sub</span><span class="op">[</span>,<span class="st">"time"</span><span class="op">]</span></span>
<span>  <span class="va">data_sub</span><span class="op">=</span><span class="va">sim_data_sub</span><span class="op">[</span>,<span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">sim_data_sub</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"event"</span>,<span class="st">"time"</span><span class="op">)</span><span class="op">]</span></span>
<span>  </span>
<span>  <span class="va">non_parallel</span><span class="op">=</span><span class="fu">bench</span><span class="fu">::</span><span class="fu"><a href="http://bench.r-lib.org/reference/mark.html" class="external-link">mark</a></span><span class="op">(</span><span class="fu"><a href="../reference/coxtp.html">coxtp</a></span><span class="op">(</span>event<span class="op">=</span><span class="va">event_sub</span>,z<span class="op">=</span><span class="va">data_sub</span>,time<span class="op">=</span><span class="va">time_sub</span>,lambda_spline <span class="op">=</span> <span class="fl">100</span><span class="op">)</span><span class="op">)</span><span class="op">[</span>,<span class="fl">1</span><span class="op">:</span><span class="fl">8</span><span class="op">]</span></span>
<span>  <span class="va">parallel</span><span class="op">=</span><span class="fu">bench</span><span class="fu">::</span><span class="fu"><a href="http://bench.r-lib.org/reference/mark.html" class="external-link">mark</a></span><span class="op">(</span><span class="fu"><a href="../reference/coxtp.html">coxtp</a></span><span class="op">(</span>event<span class="op">=</span><span class="va">event_sub</span>,z<span class="op">=</span><span class="va">data_sub</span>,time<span class="op">=</span><span class="va">time_sub</span>,lambda_spline <span class="op">=</span> <span class="fl">100</span>,parallel <span class="op">=</span> <span class="cn">T</span>,threads <span class="op">=</span> <span class="fl">4</span><span class="op">)</span><span class="op">)</span><span class="op">[</span>,<span class="fl">1</span><span class="op">:</span><span class="fl">8</span><span class="op">]</span></span>
<span>  <span class="va">non_parallel</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span><span class="op">=</span><span class="va">samplesize</span></span>
<span>  <span class="va">parallel</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span><span class="op">=</span><span class="va">samplesize</span></span>
<span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="va">i</span><span class="op">!=</span><span class="fl">1</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">non_parallel_list</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="va">non_parallel_list</span>,<span class="va">non_parallel</span><span class="op">)</span></span>
<span>    <span class="va">parallel_list</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="va">parallel_list</span>,<span class="va">parallel</span><span class="op">)</span></span>
<span>  <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>    <span class="va">non_parallel_list</span><span class="op">=</span><span class="va">non_parallel</span></span>
<span>    <span class="va">parallel_list</span><span class="op">=</span><span class="va">parallel</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="va">i</span><span class="op">=</span><span class="va">i</span><span class="op">+</span><span class="fl">1</span></span>
<span><span class="op">}</span></span>
<span><span class="co">#&gt; [1] 1</span></span>
<span><span class="co">#&gt; [1] 2</span></span>
<span><span class="co">#&gt; Warning: Some expressions had a GC in every iteration; so filtering is disabled.</span></span>
<span><span class="co">#&gt; [1] 3</span></span>
<span><span class="co">#&gt; Warning: Some expressions had a GC in every iteration; so filtering is disabled.</span></span>
<span></span>
<span><span class="co">#&gt; Warning: Some expressions had a GC in every iteration; so filtering is disabled.</span></span>
<span><span class="co">#&gt; [1] 4</span></span>
<span><span class="co">#&gt; Warning: Some expressions had a GC in every iteration; so filtering is disabled.</span></span>
<span></span>
<span><span class="co">#&gt; Warning: Some expressions had a GC in every iteration; so filtering is disabled.</span></span>
<span><span class="co">#&gt; [1] 5</span></span>
<span><span class="co">#&gt; Warning: Some expressions had a GC in every iteration; so filtering is disabled.</span></span>
<span></span>
<span><span class="co">#&gt; Warning: Some expressions had a GC in every iteration; so filtering is disabled.</span></span>
<span></span>
<span><span class="va">parallel_list</span><span class="op">$</span><span class="va">parallel</span><span class="op">=</span><span class="st">"Parallel"</span></span>
<span><span class="va">non_parallel_list</span><span class="op">$</span><span class="va">parallel</span><span class="op">=</span><span class="st">"None-Parallel"</span></span>
<span><span class="va">time_data</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="va">parallel_list</span>,<span class="va">non_parallel_list</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>median_time<span class="op">=</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_remove.html" class="external-link">str_remove</a></span><span class="op">(</span><span class="va">median</span>,<span class="st">"s"</span><span class="op">)</span>,</span>
<span>         median_time<span class="op">=</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_remove.html" class="external-link">str_remove</a></span><span class="op">(</span><span class="va">median_time</span>,<span class="st">"m"</span><span class="op">)</span>,</span>
<span>         median_time<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">median_time</span><span class="op">)</span>,</span>
<span>         median_time<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_detect.html" class="external-link">str_detect</a></span><span class="op">(</span><span class="va">median</span>,<span class="st">"ms"</span><span class="op">)</span>,<span class="va">median_time</span><span class="op">/</span><span class="fl">1000</span>,<span class="va">median_time</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span>samplesize<span class="op">=</span><span class="va">expression</span><span class="op">)</span> </span>
<span><span class="co">#Plot Time used:</span></span></code></pre></div>
<div class="sourceCode" id="cb42"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">time_data</span>,<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">samplesize</span>,y<span class="op">=</span><span class="va">median_time</span>,group<span class="op">=</span><span class="va">parallel</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>color<span class="op">=</span><span class="va">parallel</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>color<span class="op">=</span><span class="va">parallel</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>x<span class="op">=</span><span class="st">"Sample Size"</span>,y<span class="op">=</span><span class="st">"Seconds"</span>,title<span class="op">=</span><span class="st">"Internal Computation time Comparison"</span><span class="op">)</span></span></code></pre></div>
<p><img src="surtvep_files/figure-html/unnamed-chunk-42-1.png" width="672" style="display: block; margin: auto;"></p>
</div>
</div>
<div class="section level3">
<h3 id="external-comparison">6.2 External comparison<a class="anchor" aria-label="anchor" href="#external-comparison"></a>
</h3>
<div class="section level4">
<h4 id="accurancy-1">6.2.1 Accurancy<a class="anchor" aria-label="anchor" href="#accurancy-1"></a>
</h4>
<p>In this section, we are going to compare the performance between our
package and other time-varying survival packages.</p>
</div>
</div>
</div>
<div class="section level2">
<h2 id="simulation">7. Simulation<a class="anchor" aria-label="anchor" href="#simulation"></a>
</h2>
<p>In this section, we will generate our model prediction to large
dataset and illustrate how to do simulation based on our package</p>
<p>To start with, we first divided our dataset into training and testing
dataset:</p>
<div class="sourceCode" id="cb43"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sim_data</span><span class="op">=</span><span class="va">sim_data_p5</span></span>
<span><span class="co">#Generate ID for sampling</span></span>
<span><span class="va">sim_data</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">sim_data</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">sim_data</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">train_id</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">sim_data</span><span class="op">)</span><span class="op">)</span>,<span class="fl">2000</span>,replace<span class="op">=</span><span class="cn">F</span><span class="op">)</span></span>
<span><span class="va">train_data</span><span class="op">=</span><span class="va">sim_data</span><span class="op">[</span><span class="va">sim_data</span><span class="op">[</span>,<span class="fl">8</span><span class="op">]</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">train_id</span>, <span class="op">]</span></span>
<span><span class="va">test_data</span><span class="op">=</span><span class="va">sim_data</span><span class="op">[</span><span class="op">!</span><span class="va">sim_data</span><span class="op">[</span>,<span class="fl">8</span><span class="op">]</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">train_id</span>, <span class="op">]</span></span>
<span><span class="co">#Remove ID</span></span>
<span><span class="va">train_data</span><span class="op">=</span><span class="va">train_data</span><span class="op">[</span>,<span class="fl">1</span><span class="op">:</span><span class="fl">7</span><span class="op">]</span></span>
<span><span class="va">test_data</span><span class="op">=</span><span class="va">test_data</span><span class="op">[</span>,<span class="fl">1</span><span class="op">:</span><span class="fl">7</span><span class="op">]</span></span></code></pre></div>
<p>Next, we are going to build the model using the training data. The
step is similar as we have shown in previous step</p>
<div class="sourceCode" id="cb44"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">event</span><span class="op">=</span><span class="va">train_data</span><span class="op">[</span>,<span class="st">"event"</span><span class="op">]</span></span>
<span><span class="va">time</span><span class="op">=</span><span class="va">train_data</span><span class="op">[</span>,<span class="st">"time"</span><span class="op">]</span></span>
<span><span class="va">data</span><span class="op">=</span><span class="va">train_data</span><span class="op">[</span>,<span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">train_data</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"event"</span>,<span class="st">"time"</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="va">lambda_spline_all</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.001</span>,<span class="fl">0.01</span>,<span class="fl">0.1</span>,<span class="fl">1</span>,<span class="fl">10</span>,<span class="fl">100</span>,<span class="fl">1000</span><span class="op">)</span></span>
<span><span class="va">fit_penalized</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/coxtp.html">coxtp</a></span><span class="op">(</span>event <span class="op">=</span> <span class="va">event</span>, z <span class="op">=</span> <span class="va">data</span>, time <span class="op">=</span> <span class="va">time</span>,lambda_spline<span class="op">=</span><span class="va">lambda_spline_all</span><span class="op">)</span></span>
<span><span class="va">fit_penalized</span><span class="op">$</span><span class="va">lambda.selected</span></span>
<span><span class="co">#&gt;     value</span></span>
<span><span class="co">#&gt; AIC    10</span></span>
<span><span class="co">#&gt; TIC    10</span></span>
<span><span class="co">#&gt; GIC    10</span></span></code></pre></div>
<p>From the result above, we noticed that the lambda.selected is 1.
Next, we are going to predict the model using the test_data. Here we are
going to treat the <code>test_data</code> as a whole new population data
and want to predict the event probability by time.</p>
<p>From previous illustration, we know that the function
<code>cox.predict</code> could generate absolute hazard for one
individual during the time period.</p>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Xueting Tao, Lingfeng Luo, Wenbo Wu.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.6.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
