<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>fit a Cox non-proportional hazards model with p-spline or smoothing-spline, penalization tuning parameter can be chosen by information criteria or cross-validation. — coxtp • surtvep</title><!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/lumen/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous"><script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css"><script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous"><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet"><script src="../pkgdown.js"></script><meta property="og:title" content="fit a Cox non-proportional hazards model with p-spline or smoothing-spline, penalization tuning parameter can be chosen by information criteria or cross-validation. — coxtp"><meta property="og:description" content="Fit a Cox non-proportional hazards model via penalized maximum likelihood."><!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-54921687-5"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-54921687-5');
</script></head><body data-spy="scroll" data-target="#toc">
    

    <div class="container template-reference-topic">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">surtvep</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">1.0.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav"><li>
  <a href="../articles/surtvep.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu"><li>
      <a href="../articles/Model_Parameters.html">Model Parameters</a>
    </li>
    <li>
      <a href="../articles/reference.html">Reference</a>
    </li>
  </ul></li>
      </ul><ul class="nav navbar-nav navbar-right"><li>
  <a href="https://github.com/UM-KevinHe/surtvep/" class="external-link">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul></div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header">
    <h1>fit a Cox non-proportional hazards model with p-spline or smoothing-spline, penalization tuning parameter can be chosen by information criteria or cross-validation.</h1>
    <small class="dont-index">Source: <a href="https://github.com/UM-KevinHe/surtvep/blob/HEAD/R/coxtp.R" class="external-link"><code>R/coxtp.R</code></a></small>
    <div class="hidden name"><code>coxtp.Rd</code></div>
    </div>

    <div class="ref-description">
    <p>Fit a Cox non-proportional hazards model via penalized maximum likelihood.</p>
    </div>

    <div id="ref-usage">
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="fu">coxtp</span><span class="op">(</span></span>
<span>  <span class="va">event</span>,</span>
<span>  <span class="va">z</span>,</span>
<span>  <span class="va">time</span>,</span>
<span>  strata <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  penalty <span class="op">=</span> <span class="st">"Smooth-spline"</span>,</span>
<span>  nsplines <span class="op">=</span> <span class="fl">8</span>,</span>
<span>  lambda <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.1</span>, <span class="fl">1</span>, <span class="fl">10</span><span class="op">)</span>,</span>
<span>  degree <span class="op">=</span> <span class="fl">3L</span>,</span>
<span>  knots <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  ties <span class="op">=</span> <span class="st">"Breslow"</span>,</span>
<span>  tol <span class="op">=</span> <span class="fl">1e-09</span>,</span>
<span>  iter.max <span class="op">=</span> <span class="fl">20L</span>,</span>
<span>  method <span class="op">=</span> <span class="st">"ProxN"</span>,</span>
<span>  gamma <span class="op">=</span> <span class="fl">1e+08</span>,</span>
<span>  btr <span class="op">=</span> <span class="st">"dynamic"</span>,</span>
<span>  tau <span class="op">=</span> <span class="fl">0.5</span>,</span>
<span>  stop <span class="op">=</span> <span class="st">"ratch"</span>,</span>
<span>  parallel <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  threads <span class="op">=</span> <span class="fl">1L</span>,</span>
<span>  fixedstep <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  InfoCrit <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  <span class="va">...</span></span>
<span><span class="op">)</span></span></code></pre></div>
    </div>

    <div id="arguments">
    <h2>Arguments</h2>
    <dl><dt>event</dt>
<dd><p>failure events response variable of length <code>nobs</code>, where <code>nobs</code> denotes the number of observations. It should be a vector containing 0 or 1</p></dd>


<dt>z</dt>
<dd><p>input covariate matrix, of dimension <code>nobs</code> x <code>nvars</code>; each row is an observation vector.</p></dd>


<dt>time</dt>
<dd><p>observed event time, should be a vector with non-negative numeric values.</p></dd>


<dt>strata</dt>
<dd><p>stratification group defined in the data used for the stratified model.
If there exists a stratification group, please enter it as a vector.
By default, a non-stratified model would be implemented.</p></dd>


<dt>penalty</dt>
<dd><p>a character string specifying the spline term for Penalized Newton's Method.
This term is added to the log-partial likelihood as the new objective function to control the smoothness of the time-varying covariates.
Default is <code>P-spline</code>. Three options are <code>P-spline</code>, <code>Smooth-spline</code> and <code>NULL</code>. If <code>NULL</code>, the method will be the same as <code>coxtv</code> and <code>lambda</code>
will be set as 0.</p>
<p><code>P-spline</code> stands for Penalized B-spline. It combines the B-spline basis with a discrete quadratic penalty on the difference of basis coefficients between adjacent knots.
When <code>lambda</code> goes to infinity, the time-varying effects are reduced to be constant.</p>
<p><code>Smooth-spline</code> refers to the Smoothing-spline, the derivative-based penalties combined with B-splines. See <code>degree</code> for different choices.
When <code>degree=3</code>, we use the cubic B-spline penalizing the second-order derivative, which reduces the time-varying effect to a linear term when <code>lambda</code> goes to infinity.
When <code>degree=2</code>, we use the quadratic B-spline penalizing first-order derivative, which reduces the time-varying effect to a constant when <code>lambda</code> goes to infinity. See Wood (2016) for details.</p>
<p>If <code>P-spline</code> or <code>Smooth-spline</code>, then <code>lambda</code> is initialized as (0.1, 1, 10). Users can modify <code>lambda</code>. See details in <code>lambda</code>.</p></dd>


<dt>nsplines</dt>
<dd><p>number of basis functions in the B-splines to span the time-varying effects, the default value is 8.
We use the r function <code><a href="https://rdrr.io/r/splines/bs.html" class="external-link">splines::bs</a></code> to generate the B-splines.</p></dd>


<dt>lambda</dt>
<dd><p>a user-specified <code>lambda</code> sequence as the penalization coefficients in front of the spline term specified by <code>spline</code>.
This is the tuning parameter for penalization. Users can use <code>IC</code> to select the best tuning parameter based on the information criteria.
Users can specify larger values when the absolute values of the estimated time-varying effects are too large.
Default is <code>0</code>, which refers to Newton's Method without penalization.</p></dd>


<dt>degree</dt>
<dd><p>degree of the piecewise polynomial for generating the B-spline basis functions---default is 3 for cubic splines.
<code>degree = 2</code> results in the quadratic B-spline basis functions.</p>
<p>If <code>penalty</code> is <code>P-spline</code> or <code>NULL</code>, <code>degree</code>'s default value is 3.</p>
<p>If <code>penalty</code> is <code>Smooth-spline</code>, <code>degree</code>'s default value is 2.</p></dd>


<dt>knots</dt>
<dd><p>the internal knot locations (breakpoints) that define the B-splines.
The number of the internal knots should be <code>nsplines</code>-<code>degree</code>-1.
If <code>NULL</code>, the locations of knots are chosen to include an equal number of events within each time interval. This choice leads to more stable results in most cases.
Users can specify the internal knot locations by themselves.</p></dd>


<dt>ties</dt>
<dd><p>a character string specifying the method for tie handling. If there are no tied
death times, the methods are equivalent.  By default <code>"Breslow"</code> uses the Breslow approximation, which can be faster when many ties occur.</p></dd>


<dt>tol</dt>
<dd><p>convergence threshold for Newton's method. The algorithm continues until the method selected using <code>stop</code> converges.
The default value is  <code>1e-6</code>.</p></dd>


<dt>iter.max</dt>
<dd><p>maximum Iteration number if the stopping criteria specified by <code>stop</code> is not satisfied. Default value is  20.</p></dd>


<dt>method</dt>
<dd><p>a character string specifying whether to use Newton's method or Proximal Newton's method.  If <code>"Newton"</code> then exact hessian is used,
while default method <code>"ProxN"</code> implementing the proximal method which can be faster and more stable when there exists ill-conditioned second-order information of the log-partial likelihood.
See details in Wu et al. (2022).</p></dd>


<dt>gamma</dt>
<dd><p>parameter for Proximal Newton's Method <code>"ProxN"</code>. The default value is <code>1e8</code>.</p></dd>


<dt>btr</dt>
<dd><p>a character string specifying the backtracking line-search approach. <code>"dynamic"</code> is a typical way to perform backtracking line-search. See details in Convex Optimization by Boyd and Vandenberghe (2009).
<code>"static"</code> limits Newton's increment and can achieve more stable results in some extreme cases, such as ill-conditioned second-order information of the log-partial likelihood,
which usually occurs when some predictors are categorical with low frequency for some categories.
Users should be careful with <code>static</code> as this may lead to under-fitting.</p></dd>


<dt>tau</dt>
<dd><p>a scalar in (0,1) used to control the step size inside the backtracking line-search. The default value is 0.5.</p></dd>


<dt>stop</dt>
<dd><p>a character string specifying the stopping rule to determine convergence. Use \(loglik(m)\) to denote the log-partial likelihood at iteration step m.
<code>"incre"</code> means we stop the algorithm when Newton's increment is less than the <code>tol</code>.
<code>"relch"</code> means we stop the algorithm when the \(loglik(m)\) divided by the  \(loglik(0)\) is less than the <code>tol</code>.
<code>"ratch"</code> means we stop the algorithm when \((loglik(m)-loglik(m-1))/(loglik(m)-loglik(0))\) is less than the <code>tol</code>.
<code>"all"</code> means we stop the algorithm when all the stopping rules <code>"incre"</code>, <code>"relch"</code> and <code>"ratch"</code> is met.
Default value is <code>ratch</code>. If the maximum iteration steps <code>iter.max</code> is achieved, the algorithm stops before the stopping rule is met.</p></dd>


<dt>parallel</dt>
<dd><p>if <code>TRUE</code>, then the parallel computation is enabled. The number of threads in use is determined by <code>threads</code>.</p></dd>


<dt>threads</dt>
<dd><p>an integer indicating the number of threads to be used for parallel computation. Default is <code>2</code>. If <code>parallel</code> is false, then the value of <code>threads</code> has no effect.</p></dd>


<dt>fixedstep</dt>
<dd><p>if <code>TRUE</code>, the algorithm will be forced to run <code>iter.max</code> steps regardless of the stopping criterion specified.</p></dd>

</dl></div>
    <div id="value">
    <h2>Value</h2>
    

<p>A list of objects with S3 class <code>"coxtp"</code>. The length is the same as that of <code>lambda</code>; each represents the model output with each value of the tuning parameter <code>lambda</code>.</p>
<dl><dt>call</dt>
<dd><p>the call that produced this object.</p></dd>

<dt>beta</dt>
<dd><p>the estimated time varying coefficient for each predictor at each unique time. It is a matrix of dimension <code>len_unique_t</code> x <code>nvars</code>, where <code>len_unique_t</code> is the length of unique follow-up <code>time</code>.
Each row represents the coefficients at the corresponding input observation time.</p></dd>


<dt>bases</dt>
<dd><p>the basis matrix used in model fitting. If <code>ties="None"</code>, the dimension is <code>nvars</code> x <code>nsplines</code>;
if <code>ties="Breslow"</code>, the dimension is <code>len_unique_t</code> x <code>nsplines</code>. The matrix is constructed using <code>bs::splines</code> function.</p></dd>

<dt>ctrl.pts</dt>
<dd><p>estimated coefficient of the basis matrix of dimension <code>nvars</code> x <code>nsplines</code>.
Each row represents a covariate's coefficient on the <code>nsplines</code> dimensional basis functions.</p></dd>

<dt>Hessian</dt>
<dd><p>the Hessian matrix of the log-partial likelihood, of which the dimension is <code>nsplines * nvars</code> x <code>nsplines * nvars</code>.</p></dd>

<dt>internal.knots</dt>
<dd><p>the internal knot locations of the basis functions. The locations of knots are chosen to include an equal number of events within each time interval.</p></dd>

<dt>nobs</dt>
<dd><p>number of observations.</p></dd>

<dt>spline</dt>
<dd><p>the spline type user specified.</p></dd>

<dt>theta.list</dt>
<dd><p>a list of <code>ctrl.pts</code> of length <code>m</code>, contains the updated <code>ctrl.pts</code> after each algorithm iteration.</p></dd>

<dt>VarianceMatrix</dt>
<dd><p>the variance matrix of the estimated coefficients of the basis matrix, which is the inverse of the negative <code>Hessian</code> matrix.</p></dd>

</dl></div>
    <div id="details">
    <h2>Details</h2>
    <p>The sequence of models implied by <code>lambda.spline</code> is fit by Newton's method (Proximal Newton's method). The objective function is
$$loglik - P_{\lambda}$$,
where \(P_{\lambda}\) can be <code>P-spline</code> or <code>Smooth-spline</code>. The \(\lambda\) is the tuning  parameter \(\lambda\). Users can define the initial sequence.
<code>IC</code>provides different information criteria to choose the tuning parameter \(\lambda\). <code>cv.coxtp</code> uses  the cross validation to choose the tuning parameter.</p>
    </div>
    <div id="references">
    <h2>References</h2>
    <p>Gray, Robert J. (1992) Flexible methods for analyzing survival data using splines, with applications to breast cancer prognosis.
<em>Journal of the American Statistical Association</em>, <strong>87</strong>: 942-951.</p>
<p>Gray, Robert J. (1994) Spline-based tests in survival analysis.
<em>Biometrics</em>, <strong>50</strong>: 640-652.
<br></p>
<p>Lingfeng Luo, Kevin He, Wenbo Wu and Jeremy M.G. Taylor. (2022) Using information criteria to select smoothing parameters when analyzing survival data with time-varying coefficient hazard models.
<br></p>
<p>Wenbo Wu, Jeremy M.G. Taylor, Andrew F Brouwer, Lingfeng Luo, Jian Kang, Hui Jiang and Kevin He. (2022) Scalable proximal methods for cause-specific hazard modeling with time-varying coefficients
<em>Lifetime Data Analysis</em>, <strong>28(2)</strong>: 194-218.
<br></p>
<p>Wood, Simon N. (2017) P-splines with derivative based penalties and tensor product smoothing of unevenly distributed data.
<em>Statistics and Computing</em>, <strong>27(4)</strong>: 985-989.</p>
<p>Perperoglou, Aris, Saskia le Cessie, and Hans C. van Houwelingen. (2006) A fast routine for fitting Cox models with time varying effects of the covariates.
<em>Computer Methods and Programs in Biomedicine</em>, <strong>81(2)</strong>: 154-161.
<br></p>
    </div>
    <div id="see-also">
    <h2>See also</h2>
    <div class="dont-index"><p><code>coef</code>, <code>plot</code>, <code>IC</code> and <code>cv.coxtp</code>.</p></div>
    </div>

    <div id="ref-examples">
    <h2>Examples</h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">ExampleData</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">z</span> <span class="op">&lt;-</span> <span class="va">ExampleData</span><span class="op">$</span><span class="va">x</span></span></span>
<span class="r-in"><span><span class="va">time</span>  <span class="op">&lt;-</span> <span class="va">ExampleData</span><span class="op">$</span><span class="va">time</span></span></span>
<span class="r-in"><span><span class="va">event</span> <span class="op">&lt;-</span> <span class="va">ExampleData</span><span class="op">$</span><span class="va">event</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="va">lambda</span>  <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">fit</span>   <span class="op">&lt;-</span> <span class="fu">coxtp</span><span class="op">(</span>event <span class="op">=</span> <span class="va">event</span>, z <span class="op">=</span> <span class="va">z</span>, time <span class="op">=</span> <span class="va">time</span>, lambda<span class="op">=</span><span class="va">lambda</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Iter 1: Obj fun = -3.2982771; Stopping crit = 1.0000000e+00;</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Iter 2: Obj fun = -3.2916285; Stopping crit = 2.1424865e-02;</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Iter 3: Obj fun = -3.2916034; Stopping crit = 8.0884492e-05;</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Iter 4: Obj fun = -3.2916034; Stopping crit = 1.8232153e-09;</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Iter 5: Obj fun = -3.2916034; Stopping crit = 2.2895367e-14;</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Iter 1: Obj fun = -3.3017443; Stopping crit = 1.0000000e+00;</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Iter 2: Obj fun = -3.2954100; Stopping crit = 2.0664261e-02;</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Iter 3: Obj fun = -3.2953323; Stopping crit = 2.5346890e-04;</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Iter 4: Obj fun = -3.2953321; Stopping crit = 4.6097119e-07;</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Iter 5: Obj fun = -3.2953321; Stopping crit = 1.7713469e-12;</span>
<span class="r-in"><span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span></span></span>
</code></pre></div>
    </div>
  </div>
  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">
    <nav id="toc" data-toggle="toc" class="sticky-top"><h2 data-toc-skip>Contents</h2>
    </nav></div>
</div>


      <footer><div class="copyright">
  <p></p><p>Developed by Lingfeng Luo, Wenbo Wu, Xueting Tao.</p>
</div>

<div class="pkgdown">
  <p></p><p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.6.</p>
</div>

      </footer></div>

  


  

  </body></html>

